"use strict";(self.webpackChunkextension_template=self.webpackChunkextension_template||[]).push([[863],{11617:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{u:()=>u});var n=s(76743),r=s(59980),o=s(34863),a=s(31934),c=s(46668),d=s(48844),l=e([n,r,o,a,c,d]);[n,r,o,a,c,d]=l.then?(await l)():l;class u{settings;settingsUi;constructor(e,t){this.settings=e,this.settingsUi=t}getSetByQr(e){return o.c.list.find((t=>t.qrList.includes(e)))}getSetByName(e){return o.c.get(e)}getQrByLabel(e,t){const s=this.getSetByName(e);if(s)return Number.isInteger(t)?s.qrList.find((e=>e.id==t)):s.qrList.find((e=>e.label==t))}async executeQuickReplyByIndex(e){const t=[...this.settings.config.setList,...this.settings.chatConfig?.setList??[]].map((e=>e.set.qrList)).flat()[e];if(t)return await t.onExecute();throw new Error(`No quick reply at index "${e}"`)}async executeQuickReply(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const n=this.getQrByLabel(e,t);if(!n)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);return await n.execute(s,!1,!1,i)}toggleGlobalSet(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const s=this.getSetByName(e);if(!s)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.config.hasSet(s)?this.settings.config.removeSet(s):this.settings.config.addSet(s,t)}addGlobalSet(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const s=this.getSetByName(e);if(!s)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.config.addSet(s,t)}removeGlobalSet(e){const t=this.getSetByName(e);if(!t)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.config.removeSet(t)}toggleChatSet(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.settings.chatConfig)return;const s=this.getSetByName(e);if(!s)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.chatConfig.hasSet(s)?this.settings.chatConfig.removeSet(s):this.settings.chatConfig.addSet(s,t)}addChatSet(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.settings.chatConfig)return;const s=this.getSetByName(e);if(!s)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.chatConfig.addSet(s,t)}removeChatSet(e){if(!this.settings.chatConfig)return;const t=this.getSetByName(e);if(!t)throw new Error(`No quick reply set with name "${e}" found.`);this.settings.chatConfig.removeSet(t)}createQuickReply(e,t){let{icon:s,showLabel:i,message:n,title:r,isHidden:o,executeOnStartup:a,executeOnUser:c,executeOnAi:d,executeOnChatChange:l,executeOnGroupMemberDraft:u,executeOnNewChat:h,automationId:m}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const p=this.getSetByName(e);if(!p)throw new Error(`No quick reply set with named "${e}" found.`);const g=p.addQuickReply();return g.label=t??"",g.icon=s??"",g.showLabel=i??!1,g.message=n??"",g.title=r??"",g.isHidden=o??!1,g.executeOnStartup=a??!1,g.executeOnUser=c??!1,g.executeOnAi=d??!1,g.executeOnChatChange=l??!1,g.executeOnGroupMemberDraft=u??!1,g.executeOnNewChat=h??!1,g.automationId=m??"",g.onUpdate(),g}updateQuickReply(e,t){let{icon:s,showLabel:i,newLabel:n,message:r,title:o,isHidden:a,executeOnStartup:c,executeOnUser:d,executeOnAi:l,executeOnChatChange:u,executeOnGroupMemberDraft:h,executeOnNewChat:m,automationId:p}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const g=this.getQrByLabel(e,t);if(!g)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);return g.updateIcon(s??g.icon),g.updateShowLabel(i??g.showLabel),g.updateLabel(n??g.label),g.updateMessage(r??g.message),g.updateTitle(o??g.title),g.isHidden=a??g.isHidden,g.executeOnStartup=c??g.executeOnStartup,g.executeOnUser=d??g.executeOnUser,g.executeOnAi=l??g.executeOnAi,g.executeOnChatChange=u??g.executeOnChatChange,g.executeOnGroupMemberDraft=h??g.executeOnGroupMemberDraft,g.executeOnNewChat=m??g.executeOnNewChat,g.automationId=p??g.automationId,g.onUpdate(),g}deleteQuickReply(e,t){const s=this.getQrByLabel(e,t);if(!s)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);s.delete()}createContextItem(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=this.getQrByLabel(e,t),o=this.getSetByName(s);if(!n)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);if(!o)throw new Error(`No quick reply set with name "${s}" found.`);const a=new r.R;a.set=o,a.isChained=i,n.addContextLink(a)}deleteContextItem(e,t,s){const i=this.getQrByLabel(e,t),n=this.getSetByName(s);if(!i)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);if(!n)throw new Error(`No quick reply set with name "${s}" found.`);i.removeContextLink(n.name)}clearContextMenu(e,t){const s=this.getQrByLabel(e,t);if(!s)throw new Error(`No quick reply with label "${t}" in set "${e}" found.`);s.clearContextLinks()}async createSet(e){let{disableSend:t,placeBeforeInput:s,injectInput:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new o.c;n.name=e,n.disableSend=t??!1,n.placeBeforeInput=s??!1,n.injectInput=i??!1;const r=this.getSetByName(e);if(r)o.c.list.splice(o.c.list.indexOf(r),1,n);else{const t=o.c.list.findIndex((t=>1==t.name.localeCompare(e)));t>-1?o.c.list.splice(t,0,n):o.c.list.push(n)}return await n.save(),this.settingsUi.rerender(),n}async updateSet(e){let{disableSend:t,placeBeforeInput:s,injectInput:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this.getSetByName(e);if(!n)throw new Error(`No quick reply set with name "${e}" found.`);return n.disableSend=t??!1,n.placeBeforeInput=s??!1,n.injectInput=i??!1,await n.save(),this.settingsUi.rerender(),n}async deleteSet(e){const t=this.getSetByName(e);if(!t)throw new Error(`No quick reply set with name "${e}" found.`);await t.delete(),this.settingsUi.rerender()}listSets(){return o.c.list.map((e=>e.name))}listGlobalSets(){return this.settings.config.setList.map((e=>e.set.name))}listChatSets(){return this.settings.chatConfig?.setList?.flatMap((e=>e.set.name))??[]}listQuickReplies(e){const t=this.getSetByName(e);if(!t)throw new Error(`No quick reply set with name "${name}" found.`);return t.qrList.map((e=>e.label))}listAutomationIds(){return this.listSets().flatMap((e=>({set:e,qrs:this.listQuickReplies(e)}))).map((e=>e.qrs?.map((t=>this.getQrByLabel(e.set,t)?.automationId)))).flat().filter(Boolean).filter(d.eC).map(String)}}i()}catch(e){i(e)}}))},88857:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.r(t),s.d(t,{debounceAsync:()=>g.AK,debug:()=>L,log:()=>y,quickReplyApi:()=>C,warn:()=>b});var n=s(31811),r=s(25343),o=s(11617),a=s(2816),c=s(76743),d=s(13825),l=s(34863),u=s(31934),h=s(50686),m=s(84765),p=s(46668),g=s(48844),f=e([n,r,o,a,c,d,l,u,h,m,p,g]);[n,r,o,a,c,d,l,u,h,m,p,g]=f.then?(await f)():f;const v=!0,L=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return v?console.debug("[QR2]",...t):null},y=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return v?console.log("[QR2]",...t):null},b=function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return v?console.warn("[QR2]",...t):null},S={isEnabled:!1,isCombined:!1,config:{setList:[{set:"Default",isVisible:!0}]}};let q,x,E,w,C,k=!1,R=[];const O=async()=>{const e=await fetch("/api/settings/get",{method:"POST",headers:(0,n.oOe)(),body:JSON.stringify({})});if(e.ok){const t=(await e.json()).quickReplyPresets??[];for(const e of t)2!==e.version&&(e.version=2,e.disableSend=e.quickActionEnabled??!1,e.placeBeforeInput=e.placeBeforeInputEnabled??!1,e.injectInput=e.AutoInputInject??!1,e.qrList=e.quickReplySlots.map(((e,t)=>{const s={};return s.id=t+1,s.label=e.label??"",s.title=e.title??"",s.message=e.mes??"",s.isHidden=e.hidden??!1,s.executeOnStartup=e.autoExecute_appStartup??!1,s.executeOnUser=e.autoExecute_userMessage??!1,s.executeOnAi=e.autoExecute_botMessage??!1,s.executeOnChatChange=e.autoExecute_chatLoad??!1,s.executeOnGroupMemberDraft=e.autoExecute_groupMemberDraft??!1,s.executeOnNewChat=e.autoExecute_newChat??!1,s.automationId=e.automationId??"",s.contextList=(e.contextMenu??[]).map((e=>({set:e.preset,isChained:e.chain}))),s}))),2==e.version&&l.c.list.push(l.c.from(JSON.parse(JSON.stringify(e))));t.forEach(((e,t)=>{l.c.list[t].qrList=e.qrList.map((e=>c.g.from(e))),l.c.list[t].init()})),y("sets: ",l.c.list)}},A=async()=>{r.Gz.quickReplyV2||(r.Gz.quickReply?r.Gz.quickReplyV2={isEnabled:r.Gz.quickReply.quickReplyEnabled??!1,isCombined:!1,isPopout:!1,config:{setList:[{set:r.Gz.quickReply.selectedPreset??r.Gz.quickReply.name??"Default",isVisible:!0}]}}:r.Gz.quickReplyV2=S);try{q=u.P.from(r.Gz.quickReplyV2)}catch(e){q=u.P.from(S)}},I=async(e,t)=>{k?(y("calling",{functionToCall:e,args:t}),await e(...t)):(y("queueing",{functionToCall:e,args:t}),R.push((async()=>await e(...t))))},Q=async()=>{await O(),await A(),y("settings: ",q),x=new p.M(q),document.querySelector("#qr_container").append(await x.render()),E=new m.T(q),E.show(),q.onSave=()=>E.refresh(),window.executeQuickReplyByName=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=[...q.config.setList,...q.chatConfig?.setList??[]].map((e=>e.set.qrList)).flat().find((t=>t.label==e));if(!i){let[t,...s]=e.split(".");s=s.join(".");let n=l.c.get(t);n&&(i=n.qrList.find((e=>e.label==s)))}if(i&&i.onExecute)return await i.execute(t,!1,!0,s);throw new Error(`No Quick Reply found for "${e}".`)},C=new o.u(q,x);new h.j(C).init(),w=new a.Z(q),n.KNj.on(n.rlE.APP_READY,(async()=>await N())),window.quickReplyApi=C},N=async()=>{for(L("executing startup"),await w.handleStartup(),L("/executing startup"),L(`executing queue (${R.length} items)`);R.length>0;){const e=R.shift();await e()}L("/executing queue"),k=!0,L("READY")};await Q();const M=async e=>{y("CHAT_CHANGED",e),q.chatConfig=e?d.Q.from(n.L5E.quickReply??{}):null,x.rerender(),E.refresh(),await w.handleChatChanged()};n.KNj.on(n.rlE.CHAT_CHANGED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I(M,t)}));const P=async()=>{await w.handleUser()};n.KNj.makeFirst(n.rlE.USER_MESSAGE_RENDERED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I(P,t)}));const D=async e=>{["..."].includes(n.TEd[e]?.mes)?y("QR auto-execution suppressed for swiped message"):await w.handleAi()};n.KNj.makeFirst(n.rlE.CHARACTER_MESSAGE_RENDERED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I(D,t)}));const B=async()=>{await w.handleGroupMemberDraft()};n.KNj.on(n.rlE.GROUP_MEMBER_DRAFTED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I(B,t)}));const $=async e=>{await w.handleWIActivation(e)};n.KNj.on(n.rlE.WORLD_INFO_ACTIVATED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I($,t)}));const T=async()=>{await w.handleNewChat()};n.KNj.on(n.rlE.CHAT_CREATED,(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return I(T,t)})),i()}catch(e){i(e)}}),1)},2816:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{Z:()=>c});var n=s(88857),r=s(76743),o=s(31934),a=e([n,r,o]);[n,r,o]=a.then?(await a)():a;class c{settings;preventAutoExecuteStack=[];constructor(e){this.settings=e}checkExecute(){return this.settings.isEnabled&&!this.preventAutoExecuteStack.slice(-1)[0]}async performAutoExecute(e){for(const t of e){this.preventAutoExecuteStack.push(t.preventAutoExecute);try{await t.execute({isAutoExecute:!0})}catch(e){(0,n.warn)(e)}finally{this.preventAutoExecuteStack.pop()}}}async handleStartup(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnStartup)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnStartup))))?.flat()??[]];await this.performAutoExecute(e)}async handleUser(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnUser)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnUser))))?.flat()??[]];await this.performAutoExecute(e)}async handleAi(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnAi)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnAi))))?.flat()??[]];await this.performAutoExecute(e)}async handleChatChanged(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnChatChange)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnChatChange))))?.flat()??[]];await this.performAutoExecute(e)}async handleGroupMemberDraft(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnGroupMemberDraft)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnGroupMemberDraft))))?.flat()??[]];await this.performAutoExecute(e)}async handleNewChat(){if(!this.checkExecute())return;const e=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.executeOnNewChat)))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.executeOnNewChat))))?.flat()??[]];await this.performAutoExecute(e)}async handleWIActivation(e){if(!this.checkExecute()||!Array.isArray(e)||0===e.length)return;const t=e.map((e=>e.automationId)).filter(Boolean);if(0===t.length)return;const s=[...this.settings.config.setList.map((e=>e.set.qrList.filter((e=>e.automationId&&t.includes(e.automationId))))).flat(),...this.settings.chatConfig?.setList?.map((e=>e.set.qrList.filter((e=>e.automationId&&t.includes(e.automationId)))))?.flat()??[]];await this.performAutoExecute(s)}}i()}catch(e){i(e)}}))},76743:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{g:()=>q});var n=s(29280),r=s(77859),o=s(62611),a=s(95242),c=s(66347),d=s(25271),l=s(84425),u=s(60637),h=s(40839),m=s(96785),p=s(51910),g=s(51208),f=s(48844),v=s(88857),L=s(59980),y=s(34863),b=s(13269),S=e([r,o,c,d,l,u,h,p,g,f,v,L,y,b]);[r,o,c,d,l,u,h,p,g,f,v,L,y,b]=S.then?(await S)():S;class q{static from(e){return e.contextList=(e.contextList??[]).map((e=>L.R.from(e))),Object.assign(new this,e)}id;icon;label="";showLabel=!1;title="";message="";contextList;preventAutoExecute=!0;isHidden=!1;executeOnStartup=!1;executeOnUser=!1;executeOnAi=!1;executeOnChatChange=!1;executeOnGroupMemberDraft=!1;executeOnNewChat=!1;automationId="";onExecute;onDebug;onDelete;onUpdate;onInsertBefore;onTransfer;dom;domIcon;domLabel;settingsDom;settingsDomIcon;settingsDomLabel;settingsDomMessage;editorPopup;editorDom;editorMessage;editorMessageLabel;editorSyntax;editorExecuteBtn;editorExecuteBtnPause;editorExecuteBtnStop;editorExecuteProgress;editorExecuteErrors;editorExecuteResult;editorDebugState;editorExecutePromise;isExecuting;abortController;debugController;get hasContext(){return this.contextList&&this.contextList.filter((e=>e.set)).length>0}unrender(){this.dom?.remove(),this.dom=null}updateRender(){this.dom&&(this.dom.title=this.title||this.message,this.icon?(this.domIcon.classList.remove("qr--hidden"),this.showLabel?this.domLabel.classList.remove("qr--hidden"):this.domLabel.classList.add("qr--hidden")):(this.domIcon.classList.add("qr--hidden"),this.domLabel.classList.remove("qr--hidden")),this.domLabel.textContent=this.label,this.dom.classList[this.hasContext?"add":"remove"]("qr--hasCtx"))}render(){if(this.unrender(),!this.dom){const e=document.createElement("div");{this.dom=e,e.classList.add("qr--button"),e.classList.add("menu_button"),this.hasContext&&e.classList.add("qr--hasCtx"),e.title=this.title||this.message,e.addEventListener("contextmenu",(e=>{if((0,v.log)("contextmenu",this,this.hasContext),this.hasContext){e.preventDefault(),e.stopPropagation();new b.t(this).show(e)}})),e.addEventListener("click",(e=>{e.ctrlKey?this.showEditor():this.execute()}));const t=document.createElement("div");this.domIcon=t,t.classList.add("qr--button-icon"),t.classList.add("fa-solid"),this.icon?t.classList.add(this.icon):t.classList.add("qr--hidden"),e.append(t);const s=document.createElement("div");this.domLabel=s,s.classList.add("qr--button-label"),this.icon&&!this.showLabel&&s.classList.add("qr--hidden"),s.textContent=this.label,e.append(s);const i=document.createElement("div");i.classList.add("qr--button-expander"),i.textContent="⋮",i.title="Open context menu",i.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault();new b.t(this).show(e)})),e.append(i)}}return this.dom}renderSettings(e){if(!this.settingsDom){const t=document.createElement("div");{this.settingsDom=t,t.classList.add("qr--set-item"),t.setAttribute("data-order",String(e)),t.setAttribute("data-id",String(this.id));const s=document.createElement("div");{s.classList.add("qr--set-itemAdder");const e=document.createElement("div");{e.classList.add("qr--actions");const t=document.createElement("div");t.classList.add("qr--action"),t.classList.add("qr--add"),t.classList.add("menu_button"),t.classList.add("menu_button_icon"),t.classList.add("fa-solid"),t.classList.add("fa-plus"),t.title="Add quick reply",t.addEventListener("click",(()=>this.onInsertBefore())),e.append(t);const i=document.createElement("div");i.classList.add("qr--action"),i.classList.add("qr--paste"),i.classList.add("menu_button"),i.classList.add("menu_button_icon"),i.classList.add("fa-solid"),i.classList.add("fa-paste"),i.title="Add quick reply from clipboard",i.addEventListener("click",(async()=>{const e=await navigator.clipboard.readText();this.onInsertBefore(e)})),e.append(i);const n=document.createElement("div");n.classList.add("qr--action"),n.classList.add("qr--importFile"),n.classList.add("menu_button"),n.classList.add("menu_button_icon"),n.classList.add("fa-solid"),n.classList.add("fa-file-import"),n.title="Add quick reply from JSON file",n.addEventListener("click",(async()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",(async()=>{if(e.files.length>0)for(const t of e.files){const e=await t.text();this.onInsertBefore(e)}})),e.click()})),e.append(n),s.append(e)}t.append(s)}const i=document.createElement("div");{i.classList.add("qr--content");const e=document.createElement("div");e.classList.add("drag-handle"),e.classList.add("ui-sortable-handle"),e.textContent="☰",i.append(e);const s=document.createElement("div");{s.classList.add("qr--set-itemLabelContainer");const e=document.createElement("div");this.settingsDomIcon=e,e.title="Click to change icon",e.classList.add("qr--set-itemIcon"),e.classList.add("menu_button"),e.classList.add("fa-fw"),this.icon&&(e.classList.add("fa-solid"),e.classList.add(this.icon)),e.addEventListener("click",(async()=>{let e=await(0,f.oK)();this.updateIcon(e)})),s.append(e);const t=document.createElement("input");this.settingsDomLabel=t,t.classList.add("qr--set-itemLabel"),t.classList.add("text_pole"),t.value=this.label,t.addEventListener("input",(()=>this.updateLabel(t.value))),s.append(t),i.append(s)}t.append(i)}const n=document.createElement("div");{n.classList.add("qr--set-optionsContainer");const e=document.createElement("div");e.classList.add("qr--action"),e.classList.add("menu_button"),e.classList.add("fa-fw"),e.classList.add("fa-solid"),e.textContent="⁝",e.title="Additional options:\n - large editor\n - context menu\n - auto-execution\n - tooltip",e.addEventListener("click",(()=>this.showEditor())),n.append(e),i.append(n)}const o=document.createElement("textarea");this.settingsDomMessage=o,o.id=`qr--set--item${this.id}`,o.classList.add("qr--set-itemMessage"),o.value=this.message,$(o).on("input",(()=>this.updateMessage(o.value))),i.append(o);const a=document.createElement("div");{a.classList.add("qr--actions");const e=document.createElement("div");e.classList.add("qr--action"),e.classList.add("menu_button"),e.classList.add("fa-fw"),e.classList.add("fa-solid"),e.classList.add("fa-truck-arrow-right"),e.title="Move quick reply to other set",e.addEventListener("click",(()=>this.onTransfer(this))),a.append(e);const t=document.createElement("div");t.classList.add("qr--action"),t.classList.add("menu_button"),t.classList.add("fa-fw"),t.classList.add("fa-solid"),t.classList.add("fa-copy"),t.title="Copy quick reply to clipboard",t.addEventListener("click",(async()=>{await navigator.clipboard.writeText(JSON.stringify(this)),t.classList.add("qr--success"),await(0,f.cb)(3010),t.classList.remove("qr--success")})),a.append(t);const s=document.createElement("div");s.classList.add("qr--action"),s.classList.add("menu_button"),s.classList.add("fa-fw"),s.classList.add("fa-solid"),s.classList.add("fa-cut"),s.title="Cut quick reply to clipboard (copy and remove)",s.addEventListener("click",(async()=>{await navigator.clipboard.writeText(JSON.stringify(this)),this.delete()})),a.append(s);const n=document.createElement("div");n.classList.add("qr--action"),n.classList.add("menu_button"),n.classList.add("fa-fw"),n.classList.add("fa-solid"),n.classList.add("fa-file-export"),n.title="Export quick reply as file",n.addEventListener("click",(()=>{const e=new Blob([JSON.stringify(this)],{type:"text"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=`${this.label}.qr.json`,s.click()})),a.append(n);const o=document.createElement("div");o.classList.add("qr--action"),o.classList.add("menu_button"),o.classList.add("fa-fw"),o.classList.add("fa-solid"),o.classList.add("fa-trash-can"),o.classList.add("redWarningBG"),o.title="Remove Quick Reply\n---\nShift+Click to skip confirmation",o.addEventListener("click",(async e=>{if(!e.shiftKey){if(await r.zD.show.confirm("Remove Quick Reply","Are you sure you want to remove this Quick Reply?")!=r.p9.AFFIRMATIVE)return}this.delete()})),a.append(o),i.append(a)}}}return this.settingsDom}unrenderSettings(){this.settingsDom?.remove()}async showEditor(){const e=await fetch("/scripts/extensions/quick-reply/html/qrEditor.html",{cache:"no-store"});if(e.ok){this.template=document.createRange().createContextualFragment(await e.text()).querySelector("#qr--modalEditor");const t=this.template.cloneNode(!0);this.editorDom=t,this.editorPopup=new r.zD(t,r.WZ.TEXT,void 0,{okButton:"OK",wide:!0,large:!0,rows:1});const s=this.editorPopup.show(),i=t.querySelector("#qr--modal-icon");this.icon?(i.classList.add("fa-solid"),i.classList.add(this.icon)):i.textContent="…",i.addEventListener("click",(async()=>{let e=await(0,f.oK)();null!==e&&(this.icon&&i.classList.remove(this.icon),""==e?(i.classList.remove("fa-solid"),i.textContent="…"):(i.textContent="",i.classList.add("fa-solid"),i.classList.add(e)),this.updateIcon(e))}));const a=t.querySelector("#qr--modal-showLabel");a.checked=this.showLabel,a.addEventListener("click",(()=>{this.updateShowLabel(a.checked)}));const d=t.querySelector("#qr--modal-label");let l;d.value=this.label,d.addEventListener("input",(()=>{this.updateLabel(d.value)})),t.querySelector("#qr--modal-switcher").addEventListener("click",(e=>{if(l)return l.remove(),void(l=null);const t=document.createElement("ul");{l=t,t.classList.add("qr--modal-switcherList");const e=s=>{const i=document.createElement("li");{i.classList.add("qr--modal-switcherItem"),i.addEventListener("click",(()=>{t.innerHTML="";for(const s of v.quickReplyApi.listSets()){const i=document.createElement("li");{i.classList.add("qr--modal-switcherItem"),i.addEventListener("click",(()=>{t.innerHTML="",e(v.quickReplyApi.getSetByName(s))}));const n=document.createElement("div");n.classList.add("qr--label"),n.textContent=s,i.append(n),t.append(i)}}}));const s=document.createElement("div");{s.classList.add("qr--label");const e=document.createElement("i");e.classList.add("fa-solid"),e.classList.add("fa-arrow-alt-circle-right"),e.classList.add("menu_button"),s.append(e);const t=document.createElement("span");t.textContent="Switch QR Sets...",s.append(t),i.append(s)}t.append(i)}const n=document.createElement("li");{n.classList.add("qr--modal-switcherItem"),n.addEventListener("click",(()=>{const e=v.quickReplyApi.getSetByQr(this).addQuickReply();this.editorPopup.completeAffirmative(),e.showEditor()}));const e=document.createElement("div");{e.classList.add("qr--label");const t=document.createElement("i");t.classList.add("fa-solid"),t.classList.add("fa-plus"),t.classList.add("menu_button"),e.append(t);const s=document.createElement("span");s.textContent="Add QR",e.append(s),n.append(e)}t.append(n)}for(const e of s.qrList.toSorted(((e,t)=>e.label.toLowerCase().localeCompare(t.label.toLowerCase())))){const s=document.createElement("li");{s.classList.add("qr--modal-switcherItem"),e==this?s.classList.add("qr--current"):s.addEventListener("click",(()=>{this.editorPopup.completeAffirmative(),e.showEditor()}));const i=document.createElement("div");i.classList.add("qr--label"),i.textContent=e.label,s.append(i);const n=document.createElement("div");n.classList.add("qr--id"),n.textContent=e.id.toString(),s.append(n);const r=document.createElement("div");r.classList.add("qr--message"),r.textContent=e.message,s.append(r),t.append(s)}}};e(v.quickReplyApi.getSetByQr(this))}d.parentElement.append(t)}));const u=t.querySelector("#qr--modal-title");u.value=this.title,u.addEventListener("input",(()=>{this.updateTitle(u.value)}));const m=t.querySelector("#qr--modal-messageSyntaxInner");this.editorSyntax=m;const p=t.querySelector("#qr--modal-wrap");p.checked=JSON.parse(g.R.getItem("qr--wrap")??"false"),p.addEventListener("click",(()=>{g.R.setItem("qr--wrap",JSON.stringify(p.checked)),b()}));const b=()=>{p.checked?(k.style.whiteSpace="pre-wrap",m.style.whiteSpace="pre-wrap",this.clone&&(this.clone.style.whiteSpace="pre-wrap")):(k.style.whiteSpace="pre",m.style.whiteSpace="pre",this.clone&&(this.clone.style.whiteSpace="pre")),S()},S=e=>{let t=k.scrollLeft,s=k.scrollTop;e&&(e.preventDefault(),t=k.scrollLeft+e.deltaX,s=k.scrollTop+e.deltaY,k.scrollTo({behavior:"instant",left:t,top:s})),m.scrollTo({behavior:"instant",left:t,top:s})},q=()=>{C.checked?t.querySelector("#qr--modal-messageHolder").classList.remove("qr--noSyntax"):t.querySelector("#qr--modal-messageHolder").classList.add("qr--noSyntax")},x=t.querySelector("#qr--modal-tabSize");x.value=JSON.parse(g.R.getItem("qr--tabSize")??"4");const E=()=>{k.style.tabSize=x.value,m.style.tabSize=x.value,S()};x.addEventListener("change",(()=>{g.R.setItem("qr--tabSize",JSON.stringify(Number(x.value))),E()}));const w=t.querySelector("#qr--modal-executeShortcut");w.checked=JSON.parse(g.R.getItem("qr--executeShortcut")??"true"),w.addEventListener("click",(()=>{g.R.setItem("qr--executeShortcut",JSON.stringify(w.checked))}));const C=t.querySelector("#qr--modal-syntax");C.checked=JSON.parse(g.R.getItem("qr--syntax")??"true"),C.addEventListener("click",(()=>{g.R.setItem("qr--syntax",JSON.stringify(C.checked)),q()})),navigator.keyboard?navigator.keyboard.getLayoutMap().then((e=>t.querySelector("#qr--modal-commentKey").textContent=e.get("Backslash"))):t.querySelector("#qr--modal-commentKey").closest("small").remove(),this.editorMessageLabel=t.querySelector('label[for="qr--modal-message"]');const k=t.querySelector("#qr--modal-message");this.editorMessage=k,k.value=this.message;const R=(0,f.sg)((e=>this.updateMessage(e)),10);k.addEventListener("input",(()=>{R(k.value),S()}),{passive:!0});const O=()=>{const e=k.selectionStart;let t;return t=0==e||"\n"==k.value[e-1]?e:k.value.lastIndexOf("\n",e-1)+1,t};k.addEventListener("keydown",(async e=>{if(!this.isExecuting)if("Tab"!=e.key||e.shiftKey||e.ctrlKey||e.altKey)if("Tab"!=e.key||!e.shiftKey||e.ctrlKey||e.altKey)if("Enter"!=e.key||e.ctrlKey||e.shiftKey||e.altKey||A.isReplaceable&&A.isActive){if("Enter"!=e.key||!e.ctrlKey||e.shiftKey||e.altKey)if("F9"!=e.key||e.ctrlKey||e.shiftKey||e.altKey){if("Backslash"==e.code&&e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();const t=new h.M;t.parse(k.value,!1);const s=k.selectionStart,i=k.selectionEnd,n=t.commandIndex.findLast((e=>"*"==e.name&&(e.start<=s&&e.end>=s||e.start<=i&&e.end>=i)));if(n){let e=k.value.slice(n.start+1,n.end-1),t=e.length;e=e.replace(/^ /,"");const r=t-e.length;t=e.length,e=e.replace(/ $/,"");const o=t-e.length;k.selectionStart=n.start-1,k.selectionEnd=n.end+1,document.execCommand("insertText",!1,e),k.selectionStart=s-(s>=n.start?2+r:0),k.selectionEnd=i-2-r-(i>=n.end?2+o:0)}else{const e=O(),t=k.value.indexOf("\n",i);k.selectionStart=e,k.selectionEnd=t,document.execCommand("insertText",!1,`/* ${k.value.slice(e,t)} *|`),k.selectionStart=s+3,k.selectionEnd=i+3}k.dispatchEvent(new Event("input",{bubbles:!0}))}}else e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),I=k.selectionStart,Q=k.selectionEnd,P();else if(w.checked){e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault();const t=k.selectionStart,s=k.selectionEnd;k.blur(),await this.executeFromEditor(),document.activeElement!=k&&(k.focus(),k.selectionStart=t,k.selectionEnd=s)}}else{const t=k.selectionStart;let s=O();const i=/^([^\S\n]*)/.exec(k.value.slice(s))[1]??"";i.length&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),document.execCommand("insertText",!1,`\n${i}`),k.selectionStart=t+1+i.length,k.selectionEnd=k.selectionStart,k.dispatchEvent(new Event("input",{bubbles:!0})))}else{e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation();const t=k.selectionStart,s=k.selectionEnd,i=O();k.selectionStart=i;const n=k.value.substring(i,s).split("\n"),r=n.map((e=>e.replace(/^\t/,""))).join("\n"),o=n.join("\n").length-r.length;o>0?(""==r?document.execCommand("delete",!1):document.execCommand("insertText",!1,r),k.selectionStart=t-(n[0].startsWith("\t")?1:0),k.selectionEnd=s-o,k.dispatchEvent(new Event("input",{bubbles:!0}))):k.selectionStart=t}else{e.preventDefault();const t=k.selectionStart,s=k.selectionEnd;if(s-t>0&&k.value.substring(t,s).includes("\n")){e.stopImmediatePropagation(),e.stopPropagation();const i=O();k.selectionStart=i;const n=k.value.substring(i,s).split("\n");document.execCommand("insertText",!1,`\t${n.join("\n\t")}`),k.selectionStart=t+1,k.selectionEnd=s+n.length,k.dispatchEvent(new Event("input",{bubbles:!0}))}else A.isReplaceable&&A.isActive||(e.stopImmediatePropagation(),e.stopPropagation(),document.execCommand("insertText",!1,"\t"),k.dispatchEvent(new Event("input",{bubbles:!0})))}}));const A=await(0,o.nZ)(k,!0);let I,Q;k.addEventListener("wheel",(e=>{S(e)})),k.addEventListener("scroll",(e=>{S()}));const N=e=>{let t=e.start-1;for(;"/"!=k.value[t];)t--;for(;/[^\S\n]/.test(k.value[t-1]);)t--;"\n"==k.value[t-1]&&t--;let s=e.end;for(;/\s/.test(k.value[s]);)s++;"|"==k.value[s]&&s++,k.selectionStart=t,k.selectionEnd=s,document.execCommand("insertText",!1,""),k.dispatchEvent(new Event("input",{bubbles:!0}));let i=I,n=Q;return I<=t||(I>t&&Q<s?i=t:I>=s&&(i=I-(s-t))),Q<=t||(Q>t&&Q<s?n=t:Q>=s&&(n=Q-(s-t))),{start:i,end:n}},M=e=>{let t=e.start-1,s="";for(;"/"!=k.value[t];)t--;for(;/[^\S\n]/.test(k.value[t-1]);)t--,s+=k.value[t];"\n"==k.value[t-1]&&(t--,s=`\n${s}`);const i=`${s}/breakpoint |`;return k.selectionStart=t,k.selectionEnd=t,document.execCommand("insertText",!1,i),k.dispatchEvent(new Event("input",{bubbles:!0})),i.length},P=()=>{const e=k.selectionStart;let t=I,s=Q;const i=new h.M;i.parse(k.value,!1);const n=i.commandIndex.findLastIndex((t=>t.start<=e));if(n>-1){const e=i.commandIndex[n];if(e instanceof c.Y){const i=e,{start:n,end:r}=N(i);t=n,s=r}else if(i.commandIndex[n-1]instanceof c.Y){const e=i.commandIndex[n-1],{start:r,end:o}=N(e);t=r,s=o}else{const i=M(e);t+=i,s+=i}k.selectionStart=t,k.selectionEnd=s}};k.addEventListener("pointerdown",(e=>{e.ctrlKey&&e.altKey&&(I=k.selectionStart,Q=k.selectionEnd)})),k.addEventListener("pointerup",(async e=>{e.ctrlKey&&e.altKey&&k.selectionStart==k.selectionEnd&&P()}));const D=(0,f.sg)((e=>{S(e),document.activeElement==k&&(k.blur(),k.focus())}));window.addEventListener("resize",D),q();const B=()=>{m&&C.checked&&((0,n.ng)(m,`<div>${n.Y4.highlight(`${k.value}${"\n"==k.value.slice(-1)?" ":""}`,{language:"stscript",ignoreIllegals:!0})?.value}</div>`,{childrenOnly:!0}),S())};let T=0;const j=1e3/30;let G=null,U=null;const _=()=>{const e=Date.now();if(e-T<j)return requestAnimationFrame(_);if(!m||!k)return requestAnimationFrame(_);if(m.closest("body")){if(this.isExecuting)return G=null,requestAnimationFrame(_);if(U==C.checked&&G==k.value)return requestAnimationFrame(_);U=C.checked,T=e,G=k.value,B(),requestAnimationFrame(_)}};requestAnimationFrame((()=>_())),k.style.setProperty("text-shadow","none","important"),b(),E();const J=t.querySelector("#qr--ctxItem"),F=t.querySelector("#qr--ctxEditor"),H=(e,t)=>{[{name:"Select a QR set"},...y.c.list.toSorted(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase())))].forEach((s=>{const i=document.createElement("option");i.value=s.name,i.textContent=s.name,i.selected=s.name==t.set?.name,e.append(i)}))},K=(e,t)=>{const s=J.content.querySelector(".qr--ctxItem").cloneNode(!0);{s.setAttribute("data-order",String(t));const i=s.querySelector(".qr--set");H(i,e),i.addEventListener("change",(()=>{e.set=y.c.get(i.value),this.updateContext()}));const n=s.querySelector(".qr--isChained");n.checked=e.isChained,n.addEventListener("click",(()=>{e.isChained=n.checked,this.updateContext()})),s.querySelector(".qr--delete").addEventListener("click",(()=>{s.remove(),this.contextList.splice(this.contextList.indexOf(e),1),this.updateContext()})),F.append(s)}};[...this.contextList].forEach(((e,t)=>K(e,t))),t.querySelector("#qr--ctxAdd").addEventListener("click",(()=>{const e=new L.R;this.contextList.push(e),K(e,this.contextList.length-1)}));const z=()=>{this.contextList=Array.from(F.querySelectorAll(".qr--ctxItem")).map(((e,t)=>{const s=this.contextList[Number(e.getAttribute("data-order"))];return e.setAttribute("data-order",String(t)),s})),this.updateContext()};$(F).sortable({delay:(0,f.Is)(),stop:()=>z()});const V=t.querySelector("#qr--preventAutoExecute");V.checked=this.preventAutoExecute,V.addEventListener("click",(()=>{this.preventAutoExecute=V.checked,this.updateContext()}));const W=t.querySelector("#qr--isHidden");W.checked=this.isHidden,W.addEventListener("click",(()=>{this.isHidden=W.checked,this.updateContext()}));const Y=t.querySelector("#qr--executeOnStartup");Y.checked=this.executeOnStartup,Y.addEventListener("click",(()=>{this.executeOnStartup=Y.checked,this.updateContext()}));const Z=t.querySelector("#qr--executeOnUser");Z.checked=this.executeOnUser,Z.addEventListener("click",(()=>{this.executeOnUser=Z.checked,this.updateContext()}));const X=t.querySelector("#qr--executeOnAi");X.checked=this.executeOnAi,X.addEventListener("click",(()=>{this.executeOnAi=X.checked,this.updateContext()}));const ee=t.querySelector("#qr--executeOnChatChange");ee.checked=this.executeOnChatChange,ee.addEventListener("click",(()=>{this.executeOnChatChange=ee.checked,this.updateContext()}));const te=t.querySelector("#qr--executeOnGroupMemberDraft");te.checked=this.executeOnGroupMemberDraft,te.addEventListener("click",(()=>{this.executeOnGroupMemberDraft=te.checked,this.updateContext()}));const se=t.querySelector("#qr--executeOnNewChat");se.checked=this.executeOnNewChat,se.addEventListener("click",(()=>{this.executeOnNewChat=se.checked,this.updateContext()}));const ie=t.querySelector("#qr--automationId");ie.value=this.automationId,ie.addEventListener("input",(()=>{this.automationId=ie.value,this.updateContext()}));const ne=t.querySelector("#qr--modal-executeProgress");this.editorExecuteProgress=ne;const re=t.querySelector("#qr--modal-executeErrors");this.editorExecuteErrors=re;const oe=t.querySelector("#qr--modal-executeResult");this.editorExecuteResult=oe;const ae=t.querySelector("#qr--modal-debugState");this.editorDebugState=ae;const ce=t.querySelector("#qr--modal-execute");this.editorExecuteBtn=ce,ce.addEventListener("click",(async()=>{await this.executeFromEditor()}));const de=t.querySelector("#qr--modal-pause");this.editorExecuteBtnPause=de,de.addEventListener("click",(async()=>{this.abortController&&(this.abortController.signal.paused?(this.abortController.continue("Continue button clicked"),this.editorExecuteProgress.classList.remove("qr--paused")):(this.abortController.pause("Pause button clicked"),this.editorExecuteProgress.classList.add("qr--paused")))}));const le=t.querySelector("#qr--modal-stop");this.editorExecuteBtnStop=le,le.addEventListener("click",(async()=>{this.abortController?.abort("Stop button clicked")}));const ue=document.querySelector("#send_textarea"),he=t.querySelector("#qr--modal-send_textarea");he.value=ue.value;new MutationObserver((e=>{e.find((e=>[...e.removedNodes].includes(he)||[...e.removedNodes].find((e=>e.contains(he)))))&&ue.removeEventListener("input",me)})).observe(document.body,{childList:!0});const me=()=>{he.value=ue.value};ue.addEventListener("input",me),he.addEventListener("input",(()=>{ue.value=he.value}));t.querySelector("#qr--modal-resume").addEventListener("click",(()=>{this.debugController?.resume()}));t.querySelector("#qr--modal-step").addEventListener("click",(()=>{this.debugController?.step()}));t.querySelector("#qr--modal-stepInto").addEventListener("click",(()=>{this.debugController?.stepInto()}));t.querySelector("#qr--modal-stepOut").addEventListener("click",(()=>{this.debugController?.stepOut()}));t.querySelector("#qr--modal-minimize").addEventListener("click",(()=>{this.editorDom.classList.add("qr--minimized")}));t.querySelector("#qr--modal-maximize").addEventListener("click",(()=>{this.editorDom.classList.remove("qr--minimized")}));let pe,ge,fe=!1;t.querySelector("#qr--resizeHandle").addEventListener("pointerdown",(e=>{if(fe)return;fe=!0,e.preventDefault(),pe=e.x,ge=t.querySelector("#qr--qrOptions").offsetWidth;const s=(0,f.sg)((e=>{const s=ge+pe-e.x;t.querySelector("#qr--qrOptions").style.setProperty("--width",`${s}px`)}),5);window.addEventListener("pointerup",(()=>{window.removeEventListener("pointermove",s),fe=!1}),{once:!0}),window.addEventListener("pointermove",s)})),await s,window.removeEventListener("resize",D)}else(0,v.warn)("failed to fetch qrEditor template")}getEditorPosition(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const i=this.editorMessage.getBoundingClientRect(),n=window.getComputedStyle(this.editorMessage);if(!this.clone){this.clone=document.createElement("div");for(const e of n)this.clone.style[e]=n[e];this.clone.style.position="fixed",this.clone.style.visibility="hidden";new MutationObserver((e=>{e.find((e=>[...e.removedNodes].includes(this.editorMessage)||[...e.removedNodes].find((e=>e.contains(this.editorMessage)))))&&(this.clone?.remove(),this.clone=null)})).observe(document.body,{childList:!0})}document.body.append(this.clone),this.clone.style.width=`${i.width}px`,this.clone.style.height=`${i.height}px`,this.clone.style.left=`${i.left}px`,this.clone.style.top=`${i.top}px`,this.clone.style.whiteSpace=n.whiteSpace,this.clone.style.tabSize=n.tabSize;const r=s??this.editorMessage.value,o=r.slice(0,e);this.clone.textContent=o;const a=document.createElement("span");a.textContent=r.slice(e,t),this.clone.append(a),this.clone.append(r.slice(t)),this.clone.scrollTop=this.editorSyntax.scrollTop,this.clone.scrollLeft=this.editorSyntax.scrollLeft;const c=a.getBoundingClientRect(),d=document.body.getBoundingClientRect();return{left:c.left-d.left,right:c.right-d.left,top:c.top-d.top,bottom:c.bottom-d.top}}async executeFromEditor(){var e=this;if(this.isExecuting)return;this.editorPopup.onClosing=()=>!1;const t=/^[0-9a-z]{8}(-[0-9a-z]{4}){3}-[0-9a-z]{12}$/,s=this.message;this.isExecuting=!0,this.editorDom.classList.add("qr--isExecuting");const i=this.editorDom.querySelector("#qr--modal-messageHolder").classList.contains("qr--noSyntax");i&&this.editorDom.querySelector("#qr--modal-messageHolder").classList.remove("qr--noSyntax"),this.editorExecuteBtn.classList.add("qr--busy"),this.editorExecuteProgress.style.setProperty("--prog","0"),this.editorExecuteErrors.classList.remove("qr--hasErrors"),this.editorExecuteResult.classList.remove("qr--hasResult"),this.editorExecuteProgress.classList.remove("qr--error"),this.editorExecuteProgress.classList.remove("qr--success"),this.editorExecuteProgress.classList.remove("qr--paused"),this.editorExecuteProgress.classList.remove("qr--aborted"),this.editorExecuteErrors.innerHTML="",this.editorExecuteResult.innerHTML="";const r=this.editorDom.querySelector("#qr--modal-messageSyntaxInner"),o=e=>{let t=r.scrollLeft,s=r.scrollTop;e&&(e.preventDefault(),t=r.scrollLeft+e.deltaX,s=r.scrollTop+e.deltaY,r.scrollTo({behavior:"instant",left:t,top:s})),this.editorMessage.scrollTo({behavior:"instant",left:t,top:s})};r.addEventListener("wheel",(e=>{o(e)})),r.addEventListener("scroll",(e=>{o()}));try{this.abortController=new a.$,this.debugController=new l.k,this.debugController.onBreakPoint=async(s,i)=>{if(this.editorDom.classList.add("qr--isPaused"),r.innerHTML=n.Y4.highlight(`${s.fullText}${"\n"==s.fullText.slice(-1)?" ":""}`,{language:"stscript",ignoreIllegals:!0})?.value,this.editorMessageLabel.innerHTML="",t.test(s.source)){const e=document.createElement("span");e.textContent="anonymous: ",this.editorMessageLabel.append(e);const t=document.createElement("strong");t.textContent=i.source.slice(0,5),this.editorMessageLabel.append(t);const s=document.createElement("span");s.textContent=i.source.slice(5,-5),this.editorMessageLabel.append(s);const n=document.createElement("strong");n.textContent=i.source.slice(-5),this.editorMessageLabel.append(n)}else this.editorMessageLabel.textContent=i.source;const o=s.source;this.editorDebugState.innerHTML="";let a=-1;const c=[],l=[],u=function(t){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];s||a--;const i=e.debugController.stack.slice(a)[0],n=document.createElement("div");{if(n.classList.add("qr--scope"),s){const t=e.debugController.cmdStack.slice(-1)[0];{const s=document.createElement("div");s.classList.add("qr--title"),s.textContent=`Named Args - /${t.name}`,"run"==t.command.name&&(s.textContent+=`${":"==t.name?"":" "}${t.unnamedArgumentList[0]?.value}`),n.append(s);const i=new Set([...Object.keys(e.debugController.namedArguments??{}),...(t.namedArgumentList??[]).map((e=>e.name))]);for(const s of i){if("_"==s[0])continue;const i=document.createElement("div");{i.classList.add("qr--var");const r=document.createElement("div");r.classList.add("qr--key"),r.textContent=s,i.append(r);const o=document.createElement("div");{o.classList.add("qr--val"),o.classList.add("qr--singleCol");const e=t.namedArgumentList.find((e=>e.name==s))?.value;if(e instanceof d._)o.classList.add("qr--closure"),o.title=e.rawText,o.textContent=e.toString();else if(void 0===e)o.classList.add("qr--undefined"),o.textContent="undefined";else{let t;try{t=JSON.parse(e)}catch{}t&&"object"==typeof t?o.textContent=JSON.stringify(t,null,2):(o.textContent=e,o.classList.add("qr--simple"))}i.append(o)}const a=document.createElement("div");if(a.classList.add("qr--val"),a.classList.add("qr--singleCol"),void 0===e.debugController.namedArguments)a.classList.add("qr--unresolved");else{const t=e.debugController.namedArguments?.[s];if(t instanceof d._)a.classList.add("qr--closure"),a.title=t.rawText,a.textContent=t.toString();else if(void 0===t)a.classList.add("qr--undefined"),a.textContent="undefined";else{let e;try{e=JSON.parse(t)}catch{}e&&"object"==typeof e?a.textContent=JSON.stringify(e,null,2):(a.textContent=t,a.classList.add("qr--simple"))}}i.append(a),n.append(i)}}}{const s=document.createElement("div");s.classList.add("qr--title"),s.textContent=`Unnamed Args - /${t.name}`,"run"==t.command.name&&(s.textContent+=`${":"==t.name?"":" "}${t.unnamedArgumentList[0]?.value}`),n.append(s);let i=0,r=e.debugController.unnamedArguments??[];for(Array.isArray(r)||(r=[r]);r.length<t.unnamedArgumentList?.length;)r.push(void 0);r=r.map(((e,s)=>[t.unnamedArgumentList?.[s],e]));for(const t of r){i++;const s=document.createElement("div");{s.classList.add("qr--var");const r=document.createElement("div");r.classList.add("qr--key"),r.textContent=i.toString(),s.append(r);const o=document.createElement("div");{o.classList.add("qr--val"),o.classList.add("qr--singleCol");const e=t[0]?.value;if(e instanceof d._)o.classList.add("qr--closure"),o.title=e.rawText,o.textContent=e.toString();else if(void 0===e)o.classList.add("qr--undefined"),o.textContent="undefined";else{let t;try{t=JSON.parse(e)}catch{}t&&"object"==typeof t?o.textContent=JSON.stringify(t,null,2):(o.textContent=e,o.classList.add("qr--simple"))}s.append(o)}const a=document.createElement("div");if(a.classList.add("qr--val"),a.classList.add("qr--singleCol"),void 0===e.debugController.unnamedArguments)a.classList.add("qr--unresolved");else if((Array.isArray(e.debugController.unnamedArguments)?e.debugController.unnamedArguments:[e.debugController.unnamedArguments]).length<i);else{const e=t[1];if(e instanceof d._)a.classList.add("qr--closure"),a.title=e.rawText,a.textContent=e.toString();else if(void 0===e)a.classList.add("qr--undefined"),a.textContent="undefined";else{let t;try{t=JSON.parse(e)}catch{}t&&"object"==typeof t?a.textContent=JSON.stringify(t,null,2):(a.textContent=e,a.classList.add("qr--simple"))}}s.append(a),n.append(s)}}}}const a=document.createElement("div");if(a.classList.add("qr--title"),a.textContent=s?"Current Scope":"Parent Scope",i.source==o){let t;a.addEventListener("pointerenter",(()=>{const s=e.getEditorPosition(Math.max(0,i.executorList[0].start-1),i.executorList.slice(-1)[0].end,i.fullText),n=r.getBoundingClientRect();t=document.createElement("div"),t.classList.add("qr--highlight-secondary"),t.style.left=s.left-n.left+"px",t.style.width=s.right-s.left+"px",t.style.top=`${s.top-n.top+r.scrollTop}px`,t.style.height=s.bottom-s.top+"px",r.append(t)})),a.addEventListener("pointerleave",(()=>t?.remove()))}n.append(a);for(const e of Object.keys(t.variables)){const s=c.includes(e);s||c.push(e);const i=document.createElement("div");{i.classList.add("qr--var"),s&&i.classList.add("qr--isHidden");const r=document.createElement("div");r.classList.add("qr--key"),r.textContent=e,i.append(r);const o=document.createElement("div");{o.classList.add("qr--val");const s=t.variables[e];if(s instanceof d._)o.classList.add("qr--closure"),o.title=s.rawText,o.textContent=s.toString();else if(void 0===s)o.classList.add("qr--undefined"),o.textContent="undefined";else{let e;try{e=JSON.parse(s)}catch{}e&&"object"==typeof e?o.textContent=JSON.stringify(e,null,2):(o.textContent=s,o.classList.add("qr--simple"))}i.append(o)}n.append(i)}}for(const e of Object.keys(t.macros)){const s=l.includes(e);s||l.push(e);const i=document.createElement("div");{i.classList.add("qr--macro"),s&&i.classList.add("qr--isHidden");const r=document.createElement("div");r.classList.add("qr--key"),r.textContent=e,i.append(r);const o=document.createElement("div");{o.classList.add("qr--val");const s=t.macros[e];if(s instanceof d._)o.classList.add("qr--closure"),o.title=s.rawText,o.textContent=s.toString();else if(void 0===s)o.classList.add("qr--undefined"),o.textContent="undefined";else{let e;try{e=JSON.parse(s)}catch{}e&&"object"==typeof e?o.textContent=JSON.stringify(e,null,2):(o.textContent=s,o.classList.add("qr--simple"))}i.append(o)}n.append(i)}}const h=document.createElement("div");{h.classList.add("qr--pipe");const e=document.createElement("div");e.classList.add("qr--key"),e.textContent="pipe",h.append(e);const s=document.createElement("div");{s.classList.add("qr--val");const e=t.pipe;if(e instanceof d._)s.classList.add("qr--closure"),s.title=e.rawText,s.textContent=e.toString();else if(void 0===e)s.classList.add("qr--undefined"),s.textContent="undefined";else{let t;try{t=JSON.parse(e)}catch{}t&&"object"==typeof t?s.textContent=JSON.stringify(t,null,2):(s.textContent=e,s.classList.add("qr--simple"))}h.append(s)}n.append(h)}t.parent&&n.append(u(t.parent))}return n};this.editorDebugState.append(u(s.scope,!0)),this.editorDebugState.append((()=>{const e=document.createElement("div");{e.classList.add("qr--stack");const i=document.createElement("div");i.classList.add("qr--title"),i.textContent="Call Stack",e.append(i);let n=-1;for(const i of this.debugController.cmdStack.toReversed()){n++;const a=this.debugController.stack.toReversed()[n],c=document.createElement("div");{if(c.classList.add("qr--item"),i.source==o){let e;c.addEventListener("pointerenter",(()=>{const t=this.getEditorPosition(Math.max(0,i.start-1),i.end,a.fullText),s=r.getBoundingClientRect();e=document.createElement("div"),e.classList.add("qr--highlight-secondary"),e.style.left=t.left-s.left+"px",e.style.width=t.right-t.left+"px",e.style.top=`${t.top-s.top+r.scrollTop}px`,e.style.height=t.bottom-t.top+"px",r.append(e)})),c.addEventListener("pointerleave",(()=>e?.remove()))}const n=document.createElement("div");n.classList.add("qr--cmd"),n.textContent=`/${i.name}`,"run"==i.command.name&&(n.textContent+=`${":"==i.name?"":" "}${i.unnamedArgumentList[0]?.value}`),c.append(n);const d=document.createElement("div");{d.classList.add("qr--source");const e=s.fullText.slice(0,i.start).split("\n").length;if(t.test(i.source)){const t=document.createElement("span");t.classList.add("qr--fixed"),t.textContent=i.source.slice(0,5),d.append(t);const s=document.createElement("span");s.classList.add("qr--truncated"),s.textContent="…",d.append(s);const n=document.createElement("span");n.classList.add("qr--fixed"),n.textContent=`${i.source.slice(-5)}:${e}`,d.append(n),d.title=`anonymous: ${i.source}`}else d.textContent=`${i.source}:${e}`;c.append(d)}e.append(c)}}}return e})()),this.editorDebugState.classList.add("qr--active");const h=this.getEditorPosition(Math.max(0,i.start-1),i.end,s.fullText),m=r.getBoundingClientRect(),p=document.createElement("div");p.classList.add("qr--highlight"),void 0===this.debugController.namedArguments&&p.classList.add("qr--unresolved"),p.style.left=h.left-m.left+"px",p.style.width=h.right-h.left+"px",p.style.top=`${h.top-m.top+r.scrollTop}px`,p.style.height=h.bottom-h.top+"px",r.append(p);const g=await this.debugController.awaitContinue();return p.remove(),this.editorDebugState.textContent="",this.editorDebugState.classList.remove("qr--active"),this.editorDom.classList.remove("qr--isPaused"),g};const s=await this.onDebug(this);this.abortController?.signal?.aborted?this.editorExecuteProgress.classList.add("qr--aborted"):(this.editorExecuteResult.textContent=s?.toString(),this.editorExecuteResult.classList.add("qr--hasResult"),this.editorExecuteProgress.classList.add("qr--success")),this.editorExecuteProgress.classList.remove("qr--paused")}catch(e){this.editorExecuteErrors.classList.add("qr--hasErrors"),this.editorExecuteProgress.classList.add("qr--error"),this.editorExecuteProgress.classList.remove("qr--paused"),e instanceof m.M?this.editorExecuteErrors.innerHTML=`\n                    <div>${e.message}</div>\n                    <div>Line: ${e.line} Column: ${e.column}</div>\n                    <pre style="text-align:left;">${e.hint}</pre>\n                `:this.editorExecuteErrors.innerHTML=`\n                    <div>${e.message}</div>\n                `}i&&this.editorDom.querySelector("#qr--modal-messageHolder").classList.add("qr--noSyntax"),this.editorMessageLabel.innerHTML="",this.editorMessageLabel.textContent="Message / Command: ",this.editorMessage.value=s,this.editorMessage.dispatchEvent(new Event("input",{bubbles:!0})),this.editorExecutePromise=null,this.editorExecuteBtn.classList.remove("qr--busy"),this.editorDom.classList.remove("qr--isExecuting"),this.isExecuting=!1,this.editorPopup.onClosing=null}updateEditorProgress(e,t){this.editorExecuteProgress.style.setProperty("--prog",""+e/t*100)}delete(){this.onDelete&&(this.unrender(),this.unrenderSettings(),this.onDelete(this))}updateMessage(e){this.onUpdate&&(this.settingsDomMessage&&this.settingsDomMessage.value!=e&&(this.settingsDomMessage.value=e),this.message=e,this.updateRender(),this.onUpdate(this))}updateIcon(e){if(this.onUpdate){if(null===e)return;this.settingsDomIcon&&this.icon!=e&&(""==e?(this.icon&&this.settingsDomIcon.classList.remove(this.icon),this.settingsDomIcon.textContent="…",this.settingsDomIcon.classList.remove("fa-solid")):(this.icon?this.settingsDomIcon.classList.remove(this.icon):this.settingsDomIcon.classList.add("fa-solid"),this.settingsDomIcon.classList.add(e))),this.icon=e,this.updateRender(),this.onUpdate(this)}}updateShowLabel(e){this.onUpdate&&(this.showLabel=e,this.updateRender(),this.onUpdate(this))}updateLabel(e){this.onUpdate&&(this.settingsDomLabel&&this.settingsDomLabel.value!=e&&(this.settingsDomLabel.value=e),this.label=e,this.updateRender(),this.onUpdate(this))}updateTitle(e){this.onUpdate&&(this.title=e,this.updateRender(),this.onUpdate(this))}updateContext(){this.onUpdate&&(this.updateRender(),this.onUpdate(this))}addContextLink(e){this.contextList.push(e),this.updateContext()}removeContextLink(e){const t=this.contextList.findIndex((t=>t.set.name==e));t>-1&&(this.contextList.splice(t,1),this.updateContext())}clearContextLinks(){this.contextList.length&&(this.contextList.splice(0,this.contextList.length),this.updateContext())}async execute(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(this.message?.length>0&&this.onExecute){const n=new p.Zq;for(const t of Object.keys(e))"_"!=t[0]&&"isAutoExecute"!=t&&n.setMacro(`arg::${t}`,e[t]);return n.setMacro("arg::*",""),t&&(this.abortController=new a.$),await this.onExecute(this,{message:this.message,isAutoExecute:e.isAutoExecute??!1,isEditor:t,isRun:s,scope:n,executionOptions:i})}}toJSON(){return{id:this.id,icon:this.icon,showLabel:this.showLabel,label:this.label,title:this.title,message:this.message,contextList:this.contextList,preventAutoExecute:this.preventAutoExecute,isHidden:this.isHidden,executeOnStartup:this.executeOnStartup,executeOnUser:this.executeOnUser,executeOnAi:this.executeOnAi,executeOnChatChange:this.executeOnChatChange,executeOnGroupMemberDraft:this.executeOnGroupMemberDraft,executeOnNewChat:this.executeOnNewChat,automationId:this.automationId}}}i()}catch(e){i(e)}}))},13825:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{Q:()=>c});var n=s(48844),r=s(74207),o=s(34863),a=e([n,r,o]);[n,r,o]=a.then?(await a)():a;class c{setList=[];isGlobal;onUpdate;onRequestEditSet;dom;setListDom;static from(e){e.setList=e.setList?.map((e=>r.c.from(e)))?.filter((e=>e.set))??[];const t=Object.assign(new this,e);return t.init(),t}init(){this.setList.forEach((e=>this.hookQuickReplyLink(e)))}hasSet(e){return null!=this.setList.find((t=>t.set==e))}addSet(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this.hasSet(e)){const s=new r.c;s.set=e,s.isVisible=t,this.hookQuickReplyLink(s),this.setList.push(s),this.setListDom.append(s.renderSettings(this.setList.length-1)),this.update()}}removeSet(e){const t=this.setList.findIndex((t=>t.set==e));t>-1&&(this.setList.splice(t,1),this.update(),this.updateSetListDom())}renderSettingsInto(e){this.setListDom=e.querySelector(".qr--setList"),e.querySelector(".qr--setListAdd").addEventListener("click",(()=>{const e=o.c.list.find((e=>!this.setList.find((t=>t.set==e))));e?this.addSet(e):toastr.warning("All existing QR Sets have already been added.")})),this.updateSetListDom()}updateSetListDom(){this.setListDom.innerHTML="",$(this.setListDom).sortable({delay:(0,n.Is)(),stop:()=>this.onSetListSort()}),this.setList.filter((e=>!e.set.isDeleted)).forEach(((e,t)=>this.setListDom.append(e.renderSettings(t))))}onSetListSort(){this.setList=Array.from(this.setListDom.children).map(((e,t)=>{const s=this.setList[Number(e.getAttribute("data-order"))];return s.index=t,e.setAttribute("data-order",String(t)),s})),this.update()}hookQuickReplyLink(e){e.onDelete=()=>this.deleteQuickReplyLink(e),e.onUpdate=()=>this.update(),e.onRequestEditSet=()=>this.requestEditSet(e.set)}deleteQuickReplyLink(e){this.setList.splice(this.setList.indexOf(e),1),this.update()}update(){this.onUpdate&&this.onUpdate(this)}requestEditSet(e){this.onRequestEditSet&&this.onRequestEditSet(e)}toJSON(){return{setList:this.setList}}}i()}catch(e){i(e)}}))},59980:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{R:()=>o});var n=s(34863),r=e([n]);n=(r.then?(await r)():r)[0];class o{static from(e){e.set=n.c.get(e.set);return Object.assign(new this,e)}set;isChained=!1;toJSON(){return{set:this.set?.name,isChained:this.isChained}}}i()}catch(e){i(e)}}))},34863:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{c:()=>h});var n=s(31811),r=s(77859),o=s(62611),a=s(51910),c=s(40839),d=s(88857),l=s(76743),u=e([n,r,o,a,c,d,l]);[n,r,o,a,c,d,l]=u.then?(await u)():u;class h{static list=[];static from(e){e.qrList=[];return Object.assign(new this,e)}static get(e){return this.list.find((t=>t.name==e))}name;disableSend=!1;placeBeforeInput=!1;injectInput=!1;color="transparent";onlyBorderColor=!1;qrList=[];idIndex=0;isDeleted=!1;save;dom;settingsDom;constructor(){this.save=(0,d.debounceAsync)((()=>this.performSave()),200)}init(){this.qrList.forEach((e=>this.hookQuickReply(e)))}unrender(){this.dom?.remove(),this.dom=null}render(){if(this.unrender(),!this.dom){const e=document.createElement("div");this.dom=e,e.classList.add("qr--buttons"),this.updateColor(),this.qrList.filter((e=>!e.isHidden)).forEach((t=>{e.append(t.render())}))}return this.dom}rerender(){this.dom&&(this.dom.innerHTML="",this.qrList.filter((e=>!e.isHidden)).forEach((e=>{this.dom.append(e.render())})))}updateColor(){this.dom&&(this.color&&"transparent"!=this.color?(this.dom.style.setProperty("--qr--color",this.color),this.dom.classList.add("qr--color"),this.onlyBorderColor?this.dom.classList.add("qr--borderColor"):this.dom.classList.remove("qr--borderColor")):(this.dom.style.setProperty("--qr--color","transparent"),this.dom.classList.remove("qr--color"),this.dom.classList.remove("qr--borderColor")))}renderSettings(){return this.settingsDom||(this.settingsDom=document.createElement("div"),this.settingsDom.classList.add("qr--set-qrListContents"),this.qrList.forEach(((e,t)=>{this.renderSettingsItem(e,t)}))),this.settingsDom}renderSettingsItem(e,t){this.settingsDom.append(e.renderSettings(t))}async debug(e){const t=(new c.M).parse(e.message,!0,[],e.abortController,e.debugController);return t.source=`${this.name}.${e.label}`,t.onProgress=(t,s)=>e.updateEditorProgress(t,s),t.scope.setMacro("arg::*",""),(await t.execute())?.pipe}async executeWithOptions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=Object.assign({message:null,isAutoExecute:!1,isEditor:!1,isRun:!1,scope:null,executionOptions:{}},t);const s=t.executionOptions,i=document.querySelector("#send_textarea"),r=t.message??e.message;let a=i.value;if(a=!t.isAutoExecute&&!t.isEditor&&!t.isRun&&this.injectInput&&a.length>0?this.placeBeforeInput?`${r} ${a}`:`${a} ${r}`:`${r} `,"/"==a[0]&&!this.disableSend){let i;return i=t.isAutoExecute||t.isRun?await(0,o.fQ)(a,Object.assign(s,{handleParserErrors:!0,scope:t.scope,source:`${this.name}.${e.label}`})):t.isEditor?await(0,o.fQ)(a,Object.assign(s,{handleParserErrors:!1,scope:t.scope,abortController:e.abortController,source:`${this.name}.${e.label}`,onProgress:(t,s)=>e.updateEditorProgress(t,s)})):await(0,o.OK)(a,Object.assign(s,{scope:t.scope,source:`${this.name}.${e.label}`})),"object"==typeof i?i?.pipe:""}i.value=(0,n.dBL)(a),i.focus(),this.disableSend||document.querySelector("#send_but").click()}async execute(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return this.executeWithOptions(e,{message:t,isAutoExecute:s,scope:i})}addQuickReply(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=Math.max(this.idIndex,this.qrList.reduce(((e,t)=>Math.max(e,t.id)),0))+1;e.id=this.idIndex=t+1;const s=l.g.from(e);return this.qrList.push(s),this.hookQuickReply(s),this.settingsDom&&this.renderSettingsItem(s,this.qrList.length-1),this.dom&&this.dom.append(s.render()),this.save(),s}addQuickReplyFromText(e){let t;if(e){try{t=JSON.parse(e??"{}"),delete t.id}catch{}if(t){if(void 0===t.label||void 0===t.message)return void toastr.error("Not a QR.")}else t={message:e}}else t={};return this.addQuickReply(t)}hookQuickReply(e){e.onDebug=()=>this.debug(e),e.onExecute=(t,s)=>this.executeWithOptions(e,s),e.onDelete=()=>this.removeQuickReply(e),e.onUpdate=()=>this.save(),e.onInsertBefore=t=>{this.addQuickReplyFromText(t);const s=this.qrList.pop();this.qrList.splice(this.qrList.indexOf(e),0,s),e.settingsDom&&e.settingsDom.insertAdjacentElement("beforebegin",s.settingsDom),this.save()},e.onTransfer=async()=>{let t,s=!1;const i=document.createElement("div");{i.classList.add("qr--transferModal");const r=document.createElement("h3");r.textContent="Transfer Quick Reply",i.append(r);const o=document.createElement("h4");{const t=e.label,s=this.name;o.textContent=`${s}: ${t}`,i.append(o)}t=document.createElement("select");{t.classList.add("qr--transferSelect"),t.setAttribute("autofocus","1");const e=document.createElement("option");e.value="",e.textContent="-- Select QR Set --",t.append(e);for(const e of h.list){const s=document.createElement("option");s.value=e.name,s.textContent=e.name,t.append(s)}t.addEventListener("keyup",(e=>{"Shift"!=e.key||(n.dom??n.dlg).classList.remove("qr--isCopy")})),t.addEventListener("keydown",(e=>{"Shift"!=e.key?e.ctrlKey||e.altKey||"Enter"!=e.key||(e.preventDefault(),e.shiftKey&&(s=!0),n.completeAffirmative()):(n.dom??n.dlg).classList.add("qr--isCopy")})),i.append(t)}const a=document.createElement("p");{const e=document.createElement("small");e.textContent="Type or arrows to select QR Set. Enter to transfer. Shift+Enter to copy.",a.append(e),i.append(a)}}const n=new r.zD(i,r.WZ.CONFIRM,null,{okButton:"Transfer",cancelButton:"Cancel"}),o=document.createElement("div");o.classList.add("qr--copy"),o.classList.add("menu_button"),o.textContent="Copy",o.addEventListener("click",(()=>{s=!0,n.completeAffirmative()})),(n.ok??n.okButton).insertAdjacentElement("afterend",o);const a=n.show();if(t.focus(),await a,n.result==r.p9.AFFIRMATIVE){h.list.find((e=>e.name==t.value)).addQuickReply(e.toJSON()),s||e.delete()}}}removeQuickReply(e){this.qrList.splice(this.qrList.indexOf(e),1),this.save()}toJSON(){return{version:2,name:this.name,disableSend:this.disableSend,placeBeforeInput:this.placeBeforeInput,injectInput:this.injectInput,color:this.color,onlyBorderColor:this.onlyBorderColor,qrList:this.qrList,idIndex:this.idIndex}}async performSave(){const e=await fetch("/api/quick-replies/save",{method:"POST",headers:(0,n.oOe)(),body:JSON.stringify(this)});e.ok?this.rerender():((0,d.warn)(`Failed to save Quick Reply Set: ${this.name}`),console.error("QR could not be saved",e))}async delete(){if((await fetch("/api/quick-replies/delete",{method:"POST",headers:(0,n.oOe)(),body:JSON.stringify(this)})).ok){this.unrender();const e=h.list.indexOf(this);e>-1?(h.list.splice(e,1),this.isDeleted=!0):(0,d.warn)(`Deleted Quick Reply Set was not found in the list of sets: ${this.name}`)}else(0,d.warn)(`Failed to delete Quick Reply Set: ${this.name}`)}}i()}catch(e){i(e)}}))},74207:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{c:()=>o});var n=s(34863),r=e([n]);n=(r.then?(await r)():r)[0];class o{static from(e){e.set=n.c.get(e.set);return Object.assign(new this,e)}set;isVisible=!0;index;onUpdate;onRequestEditSet;onDelete;settingsDom;renderSettings(e){this.index=e;const t=document.createElement("div");{this.settingsDom=t,t.classList.add("qr--item"),t.setAttribute("data-order",String(this.index));const e=document.createElement("div");e.classList.add("drag-handle"),e.classList.add("ui-sortable-handle"),e.textContent="☰",t.append(e);const s=document.createElement("select");s.classList.add("qr--set"),s.addEventListener("touchstart",(e=>e.stopPropagation())),s.addEventListener("change",(()=>{this.set=n.c.get(s.value),this.update()})),n.c.list.toSorted(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))).forEach((e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,t.selected=e==this.set,s.append(t)})),t.append(s);const i=document.createElement("label");{i.classList.add("qr--visible"),i.title="Show buttons";const e=document.createElement("input");e.type="checkbox",e.checked=this.isVisible,e.addEventListener("click",(()=>{this.isVisible=e.checked,this.update()})),i.append(e),i.append("Buttons"),t.append(i)}const r=document.createElement("div");r.classList.add("menu_button"),r.classList.add("menu_button_icon"),r.classList.add("fa-solid"),r.classList.add("fa-pencil"),r.title="Edit quick reply set",r.addEventListener("click",(()=>this.requestEditSet())),t.append(r);const o=document.createElement("div");o.classList.add("qr--del"),o.classList.add("menu_button"),o.classList.add("menu_button_icon"),o.classList.add("fa-solid"),o.classList.add("fa-trash-can"),o.title="Remove quick reply set",o.addEventListener("click",(()=>this.delete())),t.append(o)}return this.settingsDom}unrenderSettings(){this.settingsDom?.remove(),this.settingsDom=null}update(){this.onUpdate&&this.onUpdate(this)}requestEditSet(){this.onRequestEditSet&&this.onRequestEditSet(this.set)}delete(){this.unrenderSettings(),this.onDelete&&this.onDelete()}toJSON(){return{set:this.set.name,isVisible:this.isVisible}}}i()}catch(e){i(e)}}))},31934:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{P:()=>c});var n=s(31811),r=s(25343),o=s(13825),a=e([n,r,o]);[n,r,o]=a.then?(await a)():a;class c{static from(e){e.config=o.Q.from(e.config);const t=Object.assign(new this,e);return t.init(),t}isEnabled=!1;isCombined=!1;isPopout=!1;showPopoutButton=!0;config;_chatConfig;get chatConfig(){return this._chatConfig}set chatConfig(e){this._chatConfig!=e&&(this.unhookConfig(this._chatConfig),this._chatConfig=e,this.hookConfig(this._chatConfig))}onSave;onRequestEditSet;init(){this.hookConfig(this.config),this.hookConfig(this.chatConfig)}hookConfig(e){e&&(e.onUpdate=()=>this.save(),e.onRequestEditSet=e=>this.requestEditSet(e))}unhookConfig(e){e&&(e.onUpdate=null,e.onRequestEditSet=null)}save(){r.Gz.quickReplyV2=this.toJSON(),(0,n.abt)(),this.chatConfig&&(n.L5E.quickReply=this.chatConfig.toJSON(),(0,n.fy5)()),this.onSave&&this.onSave()}requestEditSet(e){this.onRequestEditSet&&this.onRequestEditSet(e)}toJSON(){return{isEnabled:this.isEnabled,isCombined:this.isCombined,isPopout:this.isPopout,showPopoutButton:this.showPopoutButton,config:this.config}}}i()}catch(e){i(e)}}))},50686:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{j:()=>v});var n=s(70252),r=(s(95242),s(58211)),o=s(25271),a=s(60050),c=s(84425),d=s(88972),l=s(40839),u=s(51910),h=s(48844),m=s(11617),p=s(76743),g=s(34863),f=e([n,r,o,a,c,l,u,h,m,p,g]);[n,r,o,a,c,l,u,h,m,p,g]=f.then?(await f)():f;class v{api;constructor(e){this.api=e}init(){function e(e){let t="";return e.preventAutoExecute&&(t+="🚫"),e.isHidden&&(t+="👁️"),e.executeOnStartup&&(t+="🚀"),e.executeOnUser&&(t+=a.E.user),e.executeOnAi&&(t+=a.E.assistant),e.executeOnChatChange&&(t+="💬"),e.executeOnNewChat&&(t+="🆕"),e.executeOnGroupMemberDraft&&(t+=a.E.group),t}const t={qrSets:e=>g.c.list.filter((t=>t.name!=String(e.namedArgumentList.find((e=>"set"==e.name))?.value))).map((e=>new d.r(e.name,null,d.V.enum,"S"))),qrEntries:t=>g.c.get(String(t.namedArgumentList.find((e=>"set"==e.name))?.value))?.qrList.map((t=>{const s=e(t),i=`${t.automationId?`[${t.automationId}]`:""}${s?`[auto: ${s}]`:""} ${t.title||t.message}`.trim();return new d.r(t.label,i,d.V.enum,a.E.qr)}))??[],qrIds:t=>g.c.get(String(t.namedArgumentList.find((e=>"set"==e.name))?.value))?.qrList.map((t=>{const s=e(t),i=`${t.automationId?`[${t.automationId}]`:""}${s?`[auto: ${s}]`:""} ${t.title||t.message}`.trim();return new d.r(t.label,i,d.V.enum,a.E.qr,null,(()=>t.id.toString()),!0)}))??[],qrExecutables:()=>{const e=this.api.settings.config.setList,t=this.api.settings.chatConfig?.setList,s=e.map((e=>e.set.qrList.map((t=>({set:e.set,qr:t}))))).flat(),i=t?.map((e=>e.set.qrList.map((t=>({set:e.set,qr:t}))))).flat()??[],n=g.c.list.filter((s=>!e.some((e=>e.set.name===s.name&&!t?.some((e=>e.set.name===s.name)))))).map((e=>e.qrList.map((t=>({set:e,qr:t}))))).flat();return[...s.map((e=>new d.r(`${e.set.name}.${e.qr.label}`,`[global] ${e.qr.title||e.qr.message}`,d.V.name,a.E.qr))),...i.map((e=>new d.r(`${e.set.name}.${e.qr.label}`,`[chat] ${e.qr.title||e.qr.message}`,d.V.enum,a.E.qr))),...n.map((e=>new d.r(`${e.set.name}.${e.qr.label}`,`${e.qr.title||e.qr.message}`,d.V.qr,a.E.qr)))]}};window.qrEnumProviderExecutables=t.qrExecutables,l.M.addCommandObject(n.J.fromProps({name:"qr",callback:(e,t)=>this.executeQuickReplyByIndex(Number(t)),unnamedArgumentList:[new r.Up("number",[r.vM.NUMBER],!0)],helpString:"Activates the specified Quick Reply"})),l.M.addCommandObject(n.J.fromProps({name:"qrset",callback:()=>(toastr.warning("The command /qrset has been deprecated. Use /qr-set, /qr-set-on, and /qr-set-off instead."),""),helpString:"<strong>DEPRECATED</strong> – The command /qrset has been deprecated. Use /qr-set, /qr-set-on, and /qr-set-off instead."})),l.M.addCommandObject(n.J.fromProps({name:"qr-set",callback:(e,t)=>(this.toggleGlobalSet(t,e),""),namedArgumentList:[new r.vc("visible","set visibility",[r.vM.BOOLEAN],!1,!1,"true")],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Toggle global QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-set-on",callback:(e,t)=>(this.addGlobalSet(t,e),""),namedArgumentList:[new r.vc("visible","set visibility",[r.vM.BOOLEAN],!1,!1,"true")],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Activate global QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-set-off",callback:(e,t)=>(this.removeGlobalSet(t),""),unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Deactivate global QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-chat-set",callback:(e,t)=>(this.toggleChatSet(t,e),""),namedArgumentList:[new r.vc("visible","set visibility",[r.vM.BOOLEAN],!1,!1,"true")],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Toggle chat QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-chat-set-on",callback:(e,t)=>(this.addChatSet(t,e),""),namedArgumentList:[new r.vc("visible","whether the QR set should be visible",[r.vM.BOOLEAN],!1,!1,"true")],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Activate chat QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-chat-set-off",callback:(e,t)=>(this.removeChatSet(t),""),unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Deactivate chat QR set"})),l.M.addCommandObject(n.J.fromProps({name:"qr-set-list",callback:(e,t)=>JSON.stringify(this.listSets(t??"all")),returns:"list of QR sets",namedArgumentList:[],unnamedArgumentList:[new r.Up("set type",[r.vM.STRING],!1,!1,"all",["all","global","chat"])],helpString:"Gets a list of the names of all quick reply sets."})),l.M.addCommandObject(n.J.fromProps({name:"qr-list",callback:(e,t)=>JSON.stringify(this.listQuickReplies(t)),returns:"list of QRs",namedArgumentList:[],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"Gets a list of the names of all quick replies in this quick reply set."}));const s=[r.vc.fromProps({name:"set",description:"name of the QR set, e.g., set=PresetName1",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"label",description:"text on the button, e.g., label=MyButton",typeList:[r.vM.STRING],isRequired:!1,enumProvider:t.qrEntries}),r.vc.fromProps({name:"icon",description:"icon to show on the button, e.g., icon=fa-pencil",typeList:[r.vM.STRING],isRequired:!1}),r.vc.fromProps({name:"showlabel",description:"whether to show the label even when an icon is assigned, e.g., icon=fa-pencil showlabel=true",typeList:[r.vM.BOOLEAN],isRequired:!1}),new r.vc("hidden","whether the button should be hidden, e.g., hidden=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("startup","auto execute on app startup, e.g., startup=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("user","auto execute on user message, e.g., user=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("bot","auto execute on AI message, e.g., bot=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("load","auto execute on chat load, e.g., load=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("new","auto execute on new chat, e.g., new=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("group","auto execute on group member selection, e.g., group=true",[r.vM.BOOLEAN],!1,!1,"false"),new r.vc("title",'title / tooltip to be shown on button, e.g., title="My Fancy Button"',[r.vM.STRING],!1)],i=[new r.vc("newlabel","new text for the button",[r.vM.STRING],!1),r.vc.fromProps({name:"id",description:"numeric ID of the QR, e.g., id=42",typeList:[r.vM.NUMBER],isRequired:!1,enumProvider:t.qrIds})];l.M.addCommandObject(n.J.fromProps({name:"qr-create",callback:(e,t)=>(this.createQuickReply(e,t),""),namedArgumentList:s,unnamedArgumentList:[new r.Up("command",[r.vM.STRING],!0)],helpString:"\n                <div>Creates a new Quick Reply.</div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-create set=MyPreset label=MyButton /echo 123</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-get",callback:(e,t)=>this.getQuickReply(e),namedArgumentList:[r.vc.fromProps({name:"set",description:"name of the QR set, e.g., set=PresetName1",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"label",description:"text on the button, e.g., label=MyButton",typeList:[r.vM.STRING],isRequired:!1,enumProvider:t.qrEntries}),r.vc.fromProps({name:"id",description:"numeric ID of the QR, e.g., id=42",typeList:[r.vM.NUMBER],isRequired:!1,enumProvider:t.qrIds})],returns:"a dictionary with all the QR's properties",helpString:"\n                <div>Get a Quick Reply's properties.</div>\n                <div>\n                    <strong>Examples:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-get set=MyPreset label=MyButton | /echo</code></pre>\n                            <pre><code>/qr-get set=MyPreset id=42 | /echo</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-update",callback:(e,t)=>(this.updateQuickReply(e,t),""),returns:"updated quick reply",namedArgumentList:[...i,...s.map((e=>{if("label"==e.name){const t=r.vc.fromProps(e);return t.isRequired=!1,t}return e}))],unnamedArgumentList:[new r.Up("command",[r.vM.STRING])],helpString:"\n                <div>\n                    Updates Quick Reply.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-update set=MyPreset label=MyButton newlabel=MyRenamedButton /echo 123</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-delete",callback:(e,t)=>(this.deleteQuickReply(e,t),""),namedArgumentList:[r.vc.fromProps({name:"set",description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"label",description:"Quick Reply label",typeList:[r.vM.STRING],enumProvider:t.qrEntries}),r.vc.fromProps({name:"id",description:"numeric ID of the QR, e.g., id=42",typeList:[r.vM.NUMBER],enumProvider:t.qrIds})],unnamedArgumentList:[r.Up.fromProps({description:"label",typeList:[r.vM.STRING],enumProvider:t.qrEntries})],helpString:"Deletes a Quick Reply from the specified set. (Label must be provided via named or unnamed argument)"})),l.M.addCommandObject(n.J.fromProps({name:"qr-contextadd",callback:(e,t)=>(this.createContextItem(e,t),""),namedArgumentList:[r.vc.fromProps({name:"set",description:"Name of QR set to add the context menu to",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"label",description:"Label of Quick Reply to add the context menu to",typeList:[r.vM.STRING],enumProvider:t.qrEntries}),r.vc.fromProps({name:"id",description:"Numeric ID of Quick Reply to add the context menu to, e.g. id=42",typeList:[r.vM.NUMBER],enumProvider:t.qrIds}),new r.vc("chain","If true, button QR is sent together with (before) the clicked QR from the context menu",[r.vM.BOOLEAN],!1,!1,"false")],unnamedArgumentList:[r.Up.fromProps({description:"Name of QR set to add as a context menu",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"\n                <div>\n                    Add a context menu preset to a QR.\n                </div>\n                <div>\n                    If <code>id</code> and <code>label</code> are both provided, <code>id</code> will be used.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-contextadd set=MyQRSetWithTheButton label=MyButton chain=true MyQRSetWithContextItems</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-contextdel",callback:(e,t)=>(this.deleteContextItem(e,t),""),namedArgumentList:[r.vc.fromProps({name:"set",description:"Name of QR set to remove the context menu from",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"label",description:"Label of Quick Reply to remove the context menu from",typeList:[r.vM.STRING],enumProvider:t.qrEntries}),r.vc.fromProps({name:"id",description:"Numeric ID of Quick Reply to remove the context menu from, e.g. id=42",typeList:[r.vM.NUMBER],enumProvider:t.qrIds})],unnamedArgumentList:[r.Up.fromProps({description:"Name of QR set to remove",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"\n                <div>\n                    Remove context menu preset from a QR.\n                </div>\n                <div>\n                    If <code>id</code> and <code>label</code> are both provided, <code>id</code> will be used.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-contextdel set=MyPreset label=MyButton MyOtherPreset</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-contextclear",callback:(e,t)=>(this.clearContextMenu(e,t),""),namedArgumentList:[r.vc.fromProps({name:"set",description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets}),r.vc.fromProps({name:"id",description:"numeric ID of the QR, e.g., id=42",typeList:[r.vM.NUMBER],enumProvider:t.qrIds})],unnamedArgumentList:[r.Up.fromProps({description:"Quick Reply label",typeList:[r.vM.STRING],enumProvider:t.qrEntries})],helpString:"\n                <div>\n                    Remove all context menu presets from a QR.\n                </div>\n                <div>\n                    If <code>id</code> and a label are both provided, <code>id</code> will be used.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-contextclear set=MyPreset MyButton</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "}));const c=[new r.vc("nosend","disable send / insert in user input (invalid for slash commands)",[r.vM.BOOLEAN],!1),new r.vc("before","place QR before user input",[r.vM.BOOLEAN],!1),new r.vc("inject","inject user input automatically (if disabled use {{input}})",[r.vM.BOOLEAN],!1)];l.M.addCommandObject(n.J.fromProps({name:"qr-set-create",callback:async(e,t)=>(await this.createSet(t,e),""),aliases:["qr-presetadd"],namedArgumentList:c,unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets,forceEnum:!1})],helpString:"\n                <div>\n                    Create a new preset (overrides existing ones).\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <ul>\n                        <li>\n                            <pre><code>/qr-set-add MyNewPreset</code></pre>\n                        </li>\n                    </ul>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-set-update",callback:async(e,t)=>(await this.updateSet(t,e),""),aliases:["qr-presetupdate"],namedArgumentList:c,unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"\n                <div>\n                    Update an existing preset.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <pre><code>/qr-set-update enabled=false MyPreset</code></pre>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-set-delete",callback:async(e,t)=>(await this.deleteSet(t),""),aliases:["qr-presetdelete"],unnamedArgumentList:[r.Up.fromProps({description:"QR set name",typeList:[r.vM.STRING],isRequired:!0,enumProvider:t.qrSets})],helpString:"\n                <div>\n                    Delete an existing preset.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <pre><code>/qr-set-delete MyPreset</code></pre>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"qr-arg",callback:(e,t)=>{let{_scope:s}=e,[i,n]=t;return s.setMacro(`arg::${i}`,n,i.includes("*")),""},unnamedArgumentList:[r.Up.fromProps({description:"argument name",typeList:r.vM.STRING,isRequired:!0}),r.Up.fromProps({description:"argument value",typeList:[r.vM.STRING,r.vM.NUMBER,r.vM.BOOLEAN,r.vM.LIST,r.vM.DICTIONARY],isRequired:!0})],splitUnnamedArgument:!0,splitUnnamedArgumentCount:2,helpString:"\n                <div>\n                    Set a fallback value for a Quick Reply argument.\n                </div>\n                <div>\n                    <strong>Example:</strong>\n                    <pre><code>/qr-arg x foo |\n/echo {{arg::x}}</code></pre>\n                </div>\n            "})),l.M.addCommandObject(n.J.fromProps({name:"import",callback:(e,t)=>{if(!e.from)throw new Error("/import requires from= to be set.");if(!t)throw new Error("/import requires the unnamed argument to be set.");let s=[...this.api.listGlobalSets(),...this.api.listChatSets()].map((e=>this.api.getSetByName(e)?.qrList??[])).flat().find((t=>t.label==e.from));if(!s){let[t,...i]=e.from.split("."),n=i.join("."),r=g.c.get(t);r&&(s=r.qrList.find((e=>e.label==n)))}if(!s)throw new Error(`No Quick Reply found for "${name}".`);{const i=(new l.M).parse(s.message,!0,[],e._abortController,e._debugController);e._debugController&&(i.source=e.from);const n=e=>e.namedArgumentList.find((e=>"key"==e.name))&&e.unnamedArgumentList.length>0&&e.unnamedArgumentList[0].value instanceof o._||!e.namedArgumentList.find((e=>"key"==e.name))&&e.unnamedArgumentList.length>1&&e.unnamedArgumentList[1].value instanceof o._,r=i.executorList.filter((e=>["let","var"].includes(e.command.name))).filter(n).map((e=>({key:e.namedArgumentList.find((e=>"key"==e.name))?.value??e.unnamedArgumentList[0].value,value:e.unnamedArgumentList[e.namedArgumentList.find((e=>"key"==e.name))?0:1].value})));for(let s=0;s<t.length;s++){const i=t[s];let n=i;s+2<t.length&&"as"==t[s+1]&&(n=t[s+2],s+=2);const o=r.find((e=>e.key==i));if(!o)throw new Error(`No scoped closure named "${i}" found in "${e.from}"`);e._scope.existsVariableInScope(n)?e._scope.setVariable(n,o.value):e._scope.letVariable(n,o.value)}}return""},namedArgumentList:[r.vc.fromProps({name:"from",description:"Quick Reply to import from (QRSet.QRLabel)",typeList:r.vM.STRING,isRequired:!0})],unnamedArgumentList:[r.Up.fromProps({description:"what to import (x or x as y)",acceptsMultiple:!0,typeList:r.vM.STRING,isRequired:!0})],splitUnnamedArgument:!0,helpString:"\n                <div>\n                    Import one or more closures from another Quick Reply.\n                </div>\n                <div>\n                    Only imports closures that are directly assigned a scoped variable via <code>/let</code> or <code>/var</code>.\n                </div>\n                <div>\n                    <strong>Examples:</strong>\n                    <ul>\n                        <li><pre><code>/import from=LibraryQrSet.FooBar foo |\n/:foo</code></pre></li>\n                        <li><pre><code>/import from=LibraryQrSet.FooBar\n\tfoo\n\tbar\n|\n/:foo |\n/:bar</code></pre></li>\n                        <li><pre><code>/import from=LibraryQrSet.FooBar\n\tfoo as x\n\tbar as y\n|\n/:x |\n/:y</code></pre></li>\n                    </ul>\n                </div>\n            "}))}getSetByName(e){const t=this.api.getSetByName(e);return t||toastr.error(`No Quick Reply Set with the name "${e}" could be found.`),t}getQrByLabel(e,t){const s=this.api.getQrByLabel(e,t);return s||toastr.error(`No Quick Reply with the label "${t}" could be found in the set "${e}"`),s}async executeQuickReplyByIndex(e){try{return await this.api.executeQuickReplyByIndex(e)}catch(e){toastr.error(e.message)}}toggleGlobalSet(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{this.api.toggleGlobalSet(e,(0,h.Fv)(t.visible??"true"))}catch(e){toastr.error(e.message)}}addGlobalSet(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{this.api.addGlobalSet(e,(0,h.Fv)(t.visible??"true"))}catch(e){toastr.error(e.message)}}removeGlobalSet(e){try{this.api.removeGlobalSet(e)}catch(e){toastr.error(e.message)}}toggleChatSet(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{this.api.toggleChatSet(e,(0,h.Fv)(t.visible??"true"))}catch(e){toastr.error(e.message)}}addChatSet(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{this.api.addChatSet(e,(0,h.Fv)(t.visible??"true"))}catch(e){toastr.error(e.message)}}removeChatSet(e){try{this.api.removeChatSet(e)}catch(e){toastr.error(e.message)}}createQuickReply(e,t){try{this.api.createQuickReply(e.set??"",e.label??"",{icon:e.icon,showLabel:void 0===e.showlabel?void 0:(0,h.Fv)(e.showlabel),message:t??"",title:e.title,isHidden:(0,h.Fv)(e.hidden),executeOnStartup:(0,h.Fv)(e.startup),executeOnUser:(0,h.Fv)(e.user),executeOnAi:(0,h.Fv)(e.bot),executeOnChatChange:(0,h.Fv)(e.load),executeOnNewChat:(0,h.Fv)(e.new),executeOnGroupMemberDraft:(0,h.Fv)(e.group),automationId:e.automationId??""})}catch(e){toastr.error(e.message)}}getQuickReply(e){if(!e.id&&!e.label)return toastr.error("Please provide a valid id or label."),"";try{return JSON.stringify(this.api.getQrByLabel(e.set,void 0!==e.id?Number(e.id):e.label))}catch(e){toastr.error(e.message)}}updateQuickReply(e,t){try{this.api.updateQuickReply(e.set??"",void 0!==e.id?Number(e.id):e.label??"",{icon:e.icon,showLabel:void 0===e.showlabel?void 0:(0,h.Fv)(e.showlabel),newLabel:e.newlabel,message:(t??"").trim().length>0?t:void 0,title:e.title,isHidden:void 0===e.hidden?void 0:(0,h.Fv)(e.hidden),executeOnStartup:void 0===e.startup?void 0:(0,h.Fv)(e.startup),executeOnUser:void 0===e.user?void 0:(0,h.Fv)(e.user),executeOnAi:void 0===e.bot?void 0:(0,h.Fv)(e.bot),executeOnChatChange:void 0===e.load?void 0:(0,h.Fv)(e.load),executeOnGroupMemberDraft:void 0===e.group?void 0:(0,h.Fv)(e.group),executeOnNewChat:void 0===e.new?void 0:(0,h.Fv)(e.new),automationId:e.automationId??""})}catch(e){toastr.error(e.message)}}deleteQuickReply(e,t){try{this.api.deleteQuickReply(e.set,void 0!==e.id?Number(e.id):e.label??t)}catch(e){toastr.error(e.message)}}createContextItem(e,t){try{this.api.createContextItem(e.set,void 0!==e.id?Number(e.id):e.label,t,(0,h.Fv)(e.chain))}catch(e){toastr.error(e.message)}}deleteContextItem(e,t){try{this.api.deleteContextItem(e.set,void 0!==e.id?Number(e.id):e.label,t)}catch(e){toastr.error(e.message)}}clearContextMenu(e,t){try{this.api.clearContextMenu(e.set,void 0!==e.id?Number(e.id):e.label??t)}catch(e){toastr.error(e.message)}}async createSet(e,t){try{await this.api.createSet(t.name??e??"",{disableSend:(0,h.Fv)(t.nosend),placeBeforeInput:(0,h.Fv)(t.before),injectInput:(0,h.Fv)(t.inject)})}catch(e){toastr.error(e.message)}}async updateSet(e,t){try{await this.api.updateSet(t.name??e??"",{disableSend:void 0!==t.nosend?(0,h.Fv)(t.nosend):void 0,placeBeforeInput:void 0!==t.before?(0,h.Fv)(t.before):void 0,injectInput:void 0!==t.inject?(0,h.Fv)(t.inject):void 0})}catch(e){toastr.error(e.message)}}async deleteSet(e){try{await this.api.deleteSet(e??"")}catch(e){toastr.error(e.message)}}listSets(e){try{switch(e){case"global":return this.api.listGlobalSets();case"chat":return this.api.listChatSets();default:return this.api.listSets()}}catch(e){toastr.error(e.message)}}listQuickReplies(e){try{return this.api.listQuickReplies(e)}catch(e){toastr.error(e.message)}}}i()}catch(e){i(e)}}))},84765:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{T:()=>d});var n=s(31811),r=s(46411),o=s(54478),a=s(31934),c=e([n,r,o,a]);[n,r,o,a]=c.then?(await c)():c;class d{settings;dom;popoutDom;constructor(e){this.settings=e}render(){return this.settings.isPopout?this.renderPopout():this.renderBar()}unrender(){this.dom?.remove(),this.dom=null,this.popoutDom?.remove(),this.popoutDom=null}show(){if(this.settings.isEnabled)if(this.settings.isPopout)document.body.append(this.render()),(0,o.mp)(),$(this.render()).fadeIn(n.M8P),(0,r.v$)($(this.render()));else{const e=document.querySelector("#send_form");e.children.length>0?e.children[0].insertAdjacentElement("beforebegin",this.render()):e.append(this.render())}}hide(){this.unrender()}refresh(){this.hide(),this.show()}renderBar(){if(!this.dom){let e;const t=document.createElement("div");if(this.dom=t,e=t,t.id="qr--bar",t.classList.add("flex-container"),t.classList.add("flexGap5"),this.settings.showPopoutButton){t.classList.add("popoutVisible");const e=document.createElement("div");e.id="qr--popoutTrigger",e.classList.add("menu_button"),e.classList.add("fa-solid"),e.classList.add("fa-window-restore"),e.addEventListener("click",(()=>{this.settings.isPopout=!0,this.refresh(),this.settings.save()})),t.append(e)}if(this.settings.isCombined){const s=document.createElement("div");e=s,s.classList.add("qr--buttons"),t.append(s)}[...this.settings.config.setList,...this.settings.chatConfig?.setList??[]].filter((e=>e.isVisible)).forEach((t=>e.append(t.set.render())))}return this.dom}renderPopout(){if(!this.popoutDom){let e;const t=document.createElement("div");{this.popoutDom=t,t.id="qr--popout",t.classList.add("qr--popout"),t.classList.add("draggable");const s=document.createElement("div");{s.classList.add("qr--header"),t.append(s);const e=document.createElement("div");{e.classList.add("qr--controls"),e.classList.add("panelControlBar"),e.classList.add("flex-container");const t=document.createElement("div");t.id="qr--popoutheader",t.classList.add("fa-solid"),t.classList.add("fa-grip"),t.classList.add("drag-grabber"),t.classList.add("hoverglow"),e.append(t);const i=document.createElement("div");i.classList.add("qr--close"),i.classList.add("fa-solid"),i.classList.add("fa-circle-xmark"),i.classList.add("hoverglow"),i.addEventListener("click",(()=>{this.settings.isPopout=!1,this.refresh(),this.settings.save()})),e.append(i),s.append(e)}}const i=document.createElement("div");if(e=i,i.classList.add("qr--body"),this.settings.isCombined){const t=document.createElement("div");e=t,t.classList.add("qr--buttons"),i.append(t)}[...this.settings.config.setList,...this.settings.chatConfig?.setList??[]].filter((e=>e.isVisible)).forEach((t=>e.append(t.set.render()))),t.append(i)}}return this.popoutDom}}i()}catch(e){i(e)}}))},46668:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{M:()=>u});var n=s(77859),r=s(48844),o=s(88857),a=s(76743),c=s(34863),d=s(31934),l=e([n,r,o,a,c,d]);[n,r,o,a,c,d]=l.then?(await l)():l;class u{settings;template;dom;isEnabled;isCombined;showPopoutButton;globalSetList;chatSetList;currentQrSet;disableSend;placeBeforeInput;injectInput;color;onlyBorderColor;currentSet;constructor(e){this.settings=e,e.onRequestEditSet=e=>this.selectQrSet(e)}rerender(){if(!this.dom)return;const e=this.dom.querySelector(".inline-drawer-content");e.innerHTML="",Array.from(this.template.querySelector(".inline-drawer-content").cloneNode(!0).children).forEach((t=>{e.append(t)})),this.prepareDom()}unrender(){this.dom?.remove(),this.dom=null}async render(){if(!this.dom){const e=await fetch("/scripts/extensions/quick-reply/html/settings.html",{cache:"no-store"});e.ok?(this.template=document.createRange().createContextualFragment(await e.text()).querySelector("#qr--settings"),this.dom=this.template.cloneNode(!0),this.prepareDom()):(0,o.warn)("failed to fetch settings template")}return this.dom}prepareGeneralSettings(){this.isEnabled=this.dom.querySelector("#qr--isEnabled"),this.isEnabled.checked=this.settings.isEnabled,this.isEnabled.addEventListener("click",(()=>this.onIsEnabled())),this.isCombined=this.dom.querySelector("#qr--isCombined"),this.isCombined.checked=this.settings.isCombined,this.isCombined.addEventListener("click",(()=>this.onIsCombined())),this.showPopoutButton=this.dom.querySelector("#qr--showPopoutButton"),this.showPopoutButton.checked=this.settings.showPopoutButton,this.showPopoutButton.addEventListener("click",(()=>this.onShowPopoutButton()))}prepareGlobalSetList(){const e=this.template.querySelector("#qr--global").cloneNode(!0);this.settings.config.renderSettingsInto(e),this.dom.querySelector("#qr--global").replaceWith(e)}prepareChatSetList(){const e=this.template.querySelector("#qr--chat").cloneNode(!0);if(this.settings.chatConfig)this.settings.chatConfig.renderSettingsInto(e);else{const t=document.createElement("div");t.textContent="No active chat.",e.append(t)}this.dom.querySelector("#qr--chat").replaceWith(e)}prepareQrEditor(){this.dom.querySelector("#qr--set-rename").addEventListener("click",(async()=>this.renameQrSet())),this.dom.querySelector("#qr--set-new").addEventListener("click",(async()=>this.addQrSet()));const e=this.dom.querySelector("#qr--set-importFile");e.addEventListener("change",(async()=>{await this.importQrSet(e.files),e.value=null})),this.dom.querySelector("#qr--set-import").addEventListener("click",(()=>e.click())),this.dom.querySelector("#qr--set-export").addEventListener("click",(async()=>this.exportQrSet())),this.dom.querySelector("#qr--set-duplicate").addEventListener("click",(async()=>this.duplicateQrSet())),this.dom.querySelector("#qr--set-delete").addEventListener("click",(async()=>this.deleteQrSet())),this.dom.querySelector("#qr--set-add").addEventListener("click",(async()=>{this.currentQrSet.addQuickReply()})),this.dom.querySelector("#qr--set-paste").addEventListener("click",(async()=>{const e=await navigator.clipboard.readText();this.currentQrSet.addQuickReplyFromText(e)})),this.dom.querySelector("#qr--set-importQr").addEventListener("click",(async()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.addEventListener("change",(async()=>{if(e.files.length>0)for(const t of e.files){const e=await t.text();this.currentQrSet.addQuickReply(JSON.parse(e))}})),e.click()})),this.qrList=this.dom.querySelector("#qr--set-qrList"),this.currentSet=this.dom.querySelector("#qr--set"),this.currentSet.addEventListener("change",(()=>this.onQrSetChange())),c.c.list.toSorted(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))).forEach((e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,this.currentSet.append(t)})),this.disableSend=this.dom.querySelector("#qr--disableSend"),this.disableSend.addEventListener("click",(()=>{const e=this.currentQrSet;e.disableSend=this.disableSend.checked,e.save()})),this.placeBeforeInput=this.dom.querySelector("#qr--placeBeforeInput"),this.placeBeforeInput.addEventListener("click",(()=>{const e=this.currentQrSet;e.placeBeforeInput=this.placeBeforeInput.checked,e.save()})),this.injectInput=this.dom.querySelector("#qr--injectInput"),this.injectInput.addEventListener("click",(()=>{const e=this.currentQrSet;e.injectInput=this.injectInput.checked,e.save()}));let t=!0;this.color=this.dom.querySelector("#qr--color"),this.color.color=this.currentQrSet?.color??"transparent",this.color.addEventListener("change",(e=>{if(!this.dom.closest("body"))return;const s=this.currentQrSet;if(t)return t=!1,void(this.color.color=s.color);s.color=e.detail.rgb,s.save(),this.currentQrSet.updateColor()})),this.dom.querySelector("#qr--colorClear").addEventListener("click",(e=>{const t=this.currentQrSet;this.color.color="transparent",t.save(),this.currentQrSet.updateColor()})),this.onlyBorderColor=this.dom.querySelector("#qr--onlyBorderColor"),this.onlyBorderColor.addEventListener("click",(()=>{const e=this.currentQrSet;e.onlyBorderColor=this.onlyBorderColor.checked,e.save(),this.currentQrSet.updateColor()})),this.onQrSetChange()}onQrSetChange(){this.currentQrSet=c.c.get(this.currentSet.value)??new c.c,this.disableSend.checked=this.currentQrSet.disableSend,this.placeBeforeInput.checked=this.currentQrSet.placeBeforeInput,this.injectInput.checked=this.currentQrSet.injectInput,this.color.color=this.currentQrSet.color??"transparent",this.onlyBorderColor.checked=this.currentQrSet.onlyBorderColor,this.qrList.innerHTML="";const e=this.currentQrSet.renderSettings();this.qrList.append(e),$(e).sortable({delay:(0,r.Is)(),handle:".drag-handle",stop:()=>this.onQrListSort()})}prepareDom(){this.prepareGeneralSettings(),this.prepareGlobalSetList(),this.prepareChatSetList(),this.prepareQrEditor()}async onIsEnabled(){this.settings.isEnabled=this.isEnabled.checked,this.settings.save()}async onIsCombined(){this.settings.isCombined=this.isCombined.checked,this.settings.save()}async onShowPopoutButton(){this.settings.showPopoutButton=this.showPopoutButton.checked,this.settings.save()}async onGlobalSetListSort(){this.settings.config.setList=Array.from(this.globalSetList.children).map(((e,t)=>{const s=this.settings.config.setList[Number(e.getAttribute("data-order"))];return e.setAttribute("data-order",String(t)),s})),this.settings.save()}async onChatSetListSort(){this.settings.chatConfig.setList=Array.from(this.chatSetList.children).map(((e,t)=>{const s=this.settings.chatConfig.setList[Number(e.getAttribute("data-order"))];return e.setAttribute("data-order",String(t)),s})),this.settings.save()}updateOrder(e){Array.from(e.children).forEach(((e,t)=>{e.setAttribute("data-order",t)}))}async onQrListSort(){this.currentQrSet.qrList=Array.from(this.qrList.querySelectorAll(".qr--set-item")).map(((e,t)=>{const s=this.currentQrSet.qrList.find((t=>t.id==Number(e.getAttribute("data-id"))));return e.setAttribute("data-order",String(t)),s})),this.currentQrSet.save()}async deleteQrSet(){await n.zD.show.confirm("Delete Quick Reply Set",`Are you sure you want to delete the Quick Reply Set "${this.currentQrSet.name}"?<br>This cannot be undone.`)&&(await this.doDeleteQrSet(this.currentQrSet),this.rerender())}async doDeleteQrSet(e){await e.delete();for(let t=this.settings.config.setList.length-1;t>=0;t--)this.settings.config.setList[t].set==e&&this.settings.config.setList.splice(t,1);if(this.settings.chatConfig)for(let t=this.settings.chatConfig.setList.length-1;t>=0;t--)this.settings.chatConfig.setList[t].set==e&&this.settings.chatConfig.setList.splice(t,1);this.settings.save()}async renameQrSet(){const e=await n.zD.show.input("Rename Quick Reply Set","Enter a new name:",this.currentQrSet.name);if(e&&e.length>0){if(c.c.get(e))return void toastr.error(`A Quick Reply Set named "${e}" already exists.`);const t=this.currentQrSet.name;this.currentQrSet.name=e,await this.currentQrSet.save(),this.settings.config.setList.forEach((s=>{s.set.name===t&&(s.set.name=e)})),this.settings.chatConfig?.setList.forEach((s=>{s.set.name===t&&(s.set.name=e)})),this.settings.save();const s=this.currentSet.querySelector(`#qr--set option[value="${t}"]`);s.value=e,s.textContent=e,this.currentSet.value=e,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList(),console.info(`Quick Reply Set renamed from ""${t}" to "${e}".`)}}async addQrSet(){const e=await n.zD.show.input("Create a new Quick Reply Set","Enter a name for the new Quick Reply Set:");if(e&&e.length>0){const t=c.c.get(e);if(t){if(n.zD.show.confirm("Replace existing World Info",`A Quick Reply Set named "${e}" already exists.<br>Do you want to overwrite the existing Quick Reply Set?<br>The existing set will be deleted. This cannot be undone.`)){const s=c.c.list.indexOf(t);await this.doDeleteQrSet(t);const i=new c.c;i.name=e,i.addQuickReply(),c.c.list.splice(s,0,i),this.rerender(),this.currentSet.value=e,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList()}}else{const t=new c.c;t.name=e,t.addQuickReply();const s=c.c.list.findIndex((t=>1==t.name.toLowerCase().localeCompare(e.toLowerCase())));s>-1?c.c.list.splice(s,0,t):c.c.list.push(t);const i=document.createElement("option");i.value=t.name,i.textContent=t.name,s>-1?this.currentSet.children[s].insertAdjacentElement("beforebegin",i):this.currentSet.append(i),this.currentSet.value=e,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList()}}}async importQrSet(e){for(let t=0;t<e.length;t++)await this.importSingleQrSet(e.item(t))}async importSingleQrSet(e){(0,o.log)("FILE",e);try{const t=await e.text(),s=JSON.parse(t);if(Number.isInteger(s.version)&&"string"==typeof s.name){const e=c.c.from(JSON.parse(JSON.stringify(s)));e.qrList=s.qrList.map((e=>a.g.from(e))),e.init();const t=c.c.get(s.name);if(t){if(n.zD.show.confirm("Replace existing World Info",`A Quick Reply Set named "${name}" already exists.<br>Do you want to overwrite the existing Quick Reply Set?<br>The existing set will be deleted. This cannot be undone.`)){const s=c.c.list.indexOf(t);await this.doDeleteQrSet(t),c.c.list.splice(s,0,e),await e.save(),this.rerender(),this.currentSet.value=e.name,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList()}}else{const t=c.c.list.findIndex((t=>1==t.name.toLowerCase().localeCompare(e.name.toLowerCase())));t>-1?c.c.list.splice(t,0,e):c.c.list.push(e),await e.save();const s=document.createElement("option");s.value=e.name,s.textContent=e.name,t>-1?this.currentSet.children[t].insertAdjacentElement("beforebegin",s):this.currentSet.append(s),this.currentSet.value=e.name,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList()}}else toastr.error(`The file "${e.name}" does not appear to be a valid quick reply set.`),(0,o.warn)(`The file "${e.name}" does not appear to be a valid quick reply set.`)}catch(t){(0,o.warn)(t),toastr.error(`Failed to import "${e.name}":\n\n${t.message}`)}}exportQrSet(){const e=new Blob([JSON.stringify(this.currentQrSet)],{type:"application/json"}),t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=`${this.currentQrSet.name}.json`,s.click(),URL.revokeObjectURL(t)}async duplicateQrSet(){const e=await n.zD.show.input("Duplicate Quick Reply Set","Enter a name for the new Quick Reply Set:",`${this.currentQrSet.name} (Copy)`);if(e&&e.length>0){if(c.c.get(e))return void toastr.error(`A Quick Reply Set named "${e}" already exists.`);const t=c.c.from(JSON.parse(JSON.stringify(this.currentQrSet)));t.name=e,t.qrList=this.currentQrSet.qrList.map((e=>a.g.from(JSON.parse(JSON.stringify(e))))),t.addQuickReply();const s=c.c.list.findIndex((t=>1==t.name.toLowerCase().localeCompare(e.toLowerCase())));s>-1?c.c.list.splice(s,0,t):c.c.list.push(t);const i=document.createElement("option");i.value=t.name,i.textContent=t.name,s>-1?this.currentSet.children[s].insertAdjacentElement("beforebegin",i):this.currentSet.append(i),this.currentSet.value=e,this.onQrSetChange(),this.prepareGlobalSetList(),this.prepareChatSetList()}}selectQrSet(e){this.currentSet.value=e.name,this.onQrSetChange()}}i()}catch(e){i(e)}}))},13269:(e,t,s)=>{s.a(e,(async(e,i)=>{try{s.d(t,{t:()=>d});var n=s(76743),r=s(34863),o=s(83719),a=s(46851),c=e([n,r]);[n,r]=c.then?(await c)():c;class d{itemList=[];isActive=!1;root;menu;constructor(e){this.itemList=this.build(e).children,this.itemList.forEach((e=>{e.onExpand=()=>{this.itemList.filter((t=>t!==e)).forEach((e=>e.collapse()))}}))}build(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const r={icon:e.icon,showLabel:e.showLabel,label:e.label,title:e.title,message:(t&&e.message?`${t} | `:"")+e.message,children:[]};return e.contextList.forEach((t=>{if(t.set&&!s.includes(t.set)){const c=[...s,t.set],d=[...i,r.label];r.children.push(new o.j(t.set.name));const l=t.set.qrList.includes(e),u=e=>l?e.isHidden&&!!e.icon:!e.isHidden;t.set.qrList.filter(u).forEach((e=>{const s=this.build(e,t.isChained?r.message:null,c,d);r.children.push(new a.D(s.icon,s.showLabel,s.label,s.title,s.message,(i=>{i.stopPropagation();const r=Object.assign(new n.g,e);r.message=s.message.replace(/%%parent(-\d+)?%%/g,((e,t)=>d.slice(parseInt(t??"-1"))[0])),t.set.execute(r)}),s.children))}))}})),r}render(){if(!this.root){const e=document.createElement("div");{this.root=e,e.classList.add("ctx-blocker"),e.addEventListener("click",(()=>this.hide()));const t=document.createElement("ul");this.menu=t,t.classList.add("list-group"),t.classList.add("ctx-menu"),this.itemList.forEach((e=>t.append(e.render()))),e.append(t)}}return this.root}show(e){let{clientX:t,clientY:s}=e;this.isActive||(this.isActive=!0,this.render(),this.menu.style.bottom=window.innerHeight-s+"px",this.menu.style.left=`${t}px`,document.body.append(this.root))}hide(){this.root&&this.root.remove(),this.isActive=!1}toggle(e){this.isActive?this.hide():this.show(e)}}i()}catch(e){i(e)}}))},83719:(e,t,s)=>{s.d(t,{j:()=>n});var i=s(46851);class n extends i.D{constructor(e){super(null,null,e,null,null,null,[])}render(){if(!this.root){const e=document.createElement("li");this.root=e,e.classList.add("list-group-item"),e.classList.add("ctx-header"),e.append(this.label)}return this.root}}},46851:(e,t,s)=>{s.d(t,{D:()=>n});class i{itemList=[];isActive=!1;root;constructor(e){this.itemList=e}render(){if(!this.root){const e=document.createElement("ul");this.root=e,e.classList.add("list-group"),e.classList.add("ctx-menu"),e.classList.add("ctx-sub-menu"),this.itemList.forEach((t=>e.append(t.render())))}return this.root}show(e){this.isActive||(this.isActive=!0,this.render(),e.append(this.root),requestAnimationFrame((()=>{const e=this.root.getBoundingClientRect();console.log(window.innerHeight,e),e.bottom>window.innerHeight-5&&(this.root.style.top=window.innerHeight-5-e.bottom+"px"),e.right>window.innerWidth-5&&(this.root.style.left="unset",this.root.style.right="100%")})))}hide(){this.root&&(this.root.remove(),this.root.style.top="",this.root.style.left=""),this.isActive=!1}toggle(e){this.isActive?this.hide():this.show(e)}}class n{icon;showLabel;label;title;value;callback;childList=[];subMenu;root;onExpand;constructor(e,t,s,i,n,r){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[];this.icon=e,this.showLabel=t,this.label=s,this.title=i,this.value=n,this.callback=r,this.childList=o}render(){if(!this.root){const e=document.createElement("li");{this.root=e,e.classList.add("list-group-item"),e.classList.add("ctx-item"),e.title=this.title||this.value,this.callback&&e.addEventListener("click",(e=>this.callback(e,this)));const t=document.createElement("div");t.classList.add("qr--button-icon"),t.classList.add("fa-solid"),this.icon?t.classList.add(this.icon):t.classList.add("qr--hidden"),e.append(t);const s=document.createElement("div");if(s.classList.add("qr--button-label"),this.icon&&!this.showLabel&&s.classList.add("qr--hidden"),s.textContent=this.label,e.append(s),this.childList.length>0){e.classList.add("ctx-has-children");const t=new i(this.childList);this.subMenu=t;const s=document.createElement("div");s.classList.add("ctx-expander"),s.textContent="⋮",s.addEventListener("click",(e=>{e.stopPropagation(),this.toggle()})),e.append(s),e.addEventListener("mouseover",(()=>t.show(e))),e.addEventListener("mouseleave",(()=>t.hide()))}}}return this.root}expand(){this.subMenu?.show(this.root),this.onExpand&&this.onExpand()}collapse(){this.subMenu?.hide()}toggle(){this.subMenu.isActive?this.expand():this.collapse()}}}}]);